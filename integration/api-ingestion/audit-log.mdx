---
title: 'Rastreabilidade e Audit Log'
description: 'Documenta√ß√£o da Audit Log API da Nexfar: consulte hist√≥rico completo de envios, filtre por data/status/modelo, valide integridade com payload_hash. Rastreabilidade de 100% das ingest√µes.'
icon: 'list-check'
---

## Introdu√ß√£o

A Nexfar registra **100% das ingest√µes de dados** em um audit log imut√°vel, proporcionando rastreabilidade completa de todas as opera√ß√µes realizadas atrav√©s da API de Ingest√£o. Independentemente de voc√™ usar **REST** ou **GraphQL**, cada requisi√ß√£o √© automaticamente registrada com timestamp, status, payload hash e correlation ID √∫nico.

<Note>
üìù **Audit Log registra todas as ingest√µes** independentemente de REST ou GraphQL - ambos os protocolos compartilham a mesma infraestrutura de auditoria.
</Note>

### Caracter√≠sticas do Audit Log

- **Imutabilidade**: Registros s√£o append-only e nunca podem ser alterados ou deletados
- **Rastreabilidade Total**: Cada ingest√£o recebe um `correlation_id` √∫nico para rastreamento end-to-end
- **Isolamento Autom√°tico**: Voc√™ s√≥ visualiza registros do seu pr√≥prio `client_id` (extra√≠do do JWT)
- **Valida√ß√£o de Integridade**: Hash SHA-256 do payload permite verificar que dados n√£o foram corrompidos

<Tip>
üí° **Use o `correlation_id`** retornado na resposta de ingest√£o para consultar detalhes espec√≠ficos no Audit Log.
</Tip>

---

## Endpoint de Consulta

O endpoint GET `/api/v1/audit-log` permite consultar o hist√≥rico completo de envios com suporte a filtros avan√ßados e pagina√ß√£o.

### Especifica√ß√£o do Endpoint

- **M√©todo HTTP**: `GET`
- **URL Sandbox**: `https://api-sandbox.nexfar.com.br/api/v1/audit-log`
- **URL Produ√ß√£o**: `https://api.nexfar.com.br/api/v1/audit-log`
- **Autentica√ß√£o**: Bearer token JWT (obrigat√≥rio)

### Exemplo B√°sico

```bash
curl -X GET "https://api-sandbox.nexfar.com.br/api/v1/audit-log" \
  -H "Authorization: Bearer SEU_TOKEN_JWT_AQUI"
```

<Warning>
üîí **Isolamento Autom√°tico**: O endpoint filtra automaticamente por `client_id` do JWT - voc√™ s√≥ v√™ seus pr√≥prios registros.
</Warning>

---

## Query Parameters

Todos os par√¢metros s√£o opcionais. Se nenhum filtro for fornecido, retorna todos os registros do seu `client_id` ordenados por data (mais recentes primeiro).

| Par√¢metro | Tipo | Obrigat√≥rio | Descri√ß√£o | Exemplo |
|-----------|------|-------------|-----------|---------|
| `date_from` | string (ISO 8601) | N√£o | Data inicial para filtrar registros (formato: `YYYY-MM-DD` ou `YYYY-MM-DDTHH:mm:ssZ`) | `2025-11-01` ou `2025-11-01T00:00:00Z` |
| `date_to` | string (ISO 8601) | N√£o | Data final para filtrar registros (formato: `YYYY-MM-DD` ou `YYYY-MM-DDTHH:mm:ssZ`) | `2025-11-10` ou `2025-11-10T23:59:59Z` |
| `status` | string (enum) | N√£o | Status da ingest√£o: `received`, `processed`, `failed` | `failed` |
| `model` | string | N√£o | Nome do modelo para filtrar (ex: `client`, `product`, `order`) | `client` |
| `page` | integer | N√£o | N√∫mero da p√°gina (inicia em 1, default: 1) | `2` |
| `page_size` | integer | N√£o | Tamanho da p√°gina (default: 20, m√°ximo: 100) | `50` |

<Note>
üìù **Sem filtros?** Retorna todos os registros do seu `client_id` ordenados por data (mais recentes primeiro).
</Note>

<Tip>
üí° **Per√≠odos Espec√≠ficos**: Use `date_from` e `date_to` para an√°lise mensal ou semanal.
</Tip>

---

## Estrutura da Resposta

A resposta √© paginada e inclui metadados de pagina√ß√£o.

### Exemplo de Resposta JSON

```json
{
  "data": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "timestamp": "2025-11-08T14:32:15Z",
      "model": "client",
      "endpoint": "/api/v1/clients",
      "status": "processed",
      "payload_hash": "a3b5c7d9e1f2a4b6c8d0e2f4a6b8c0d2e4f6a8b0c2d4e6f8a0b2c4d6e8f0a2b4",
      "correlation_id": "770e9511-f30c-52e5-b827-557766551111"
    }
  ],
  "metadata": {
    "total_records": 1234,
    "total_pages": 62,
    "current_page": 1,
    "page_size": 20
  }
}
```

### Campos da Resposta

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `id` | UUID | Identificador √∫nico da entrada no audit log |
| `timestamp` | string (ISO 8601) | Data/hora da ingest√£o |
| `model` | string | Nome do modelo ingerido (ex: `client`, `product`, `order`) |
| `endpoint` | string | Endpoint REST ou mutation GraphQL utilizada |
| `status` | string (enum) | Status: `received`, `processed`, `failed` |
| `payload_hash` | string | Hash SHA-256 do payload para valida√ß√£o de integridade |
| `correlation_id` | UUID | ID de correla√ß√£o para rastreamento end-to-end |

### Metadata de Pagina√ß√£o

| Campo | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `total_records` | integer | Total de registros encontrados |
| `total_pages` | integer | Total de p√°ginas dispon√≠veis |
| `current_page` | integer | P√°gina atual |
| `page_size` | integer | Itens por p√°gina |

<Info>
‚ÑπÔ∏è **Campo `payload` omitido**: O payload completo n√£o √© retornado por padr√£o (apenas admin) - use `payload_hash` para validar integridade.
</Info>

---

## Exemplos de Uso

<Tabs>
  <Tab title="√öltimos 7 dias">
    ```bash
    curl -X GET "https://api-sandbox.nexfar.com.br/api/v1/audit-log?date_from=2025-11-01&date_to=2025-11-08" \
      -H "Authorization: Bearer SEU_TOKEN_JWT_AQUI"
    ```
  </Tab>

  <Tab title="Apenas falhas">
    ```bash
    curl -X GET "https://api-sandbox.nexfar.com.br/api/v1/audit-log?status=failed" \
      -H "Authorization: Bearer SEU_TOKEN_JWT_AQUI"
    ```
  </Tab>

  <Tab title="Modelo espec√≠fico (clients)">
    ```bash
    curl -X GET "https://api-sandbox.nexfar.com.br/api/v1/audit-log?model=client&page=1&page_size=20" \
      -H "Authorization: Bearer SEU_TOKEN_JWT_AQUI"
    ```
  </Tab>

  <Tab title="Pagina√ß√£o - P√°gina 2">
    ```bash
    curl -X GET "https://api-sandbox.nexfar.com.br/api/v1/audit-log?page=2&page_size=50" \
      -H "Authorization: Bearer SEU_TOKEN_JWT_AQUI"
    ```
  </Tab>
</Tabs>

### Exemplo em Python

```python
import requests
import os

url = "https://api-sandbox.nexfar.com.br/api/v1/audit-log"
headers = {
    "Authorization": f"Bearer {os.getenv('NEXFAR_JWT_TOKEN')}"
}
params = {
    "date_from": "2025-11-01",
    "date_to": "2025-11-08",
    "status": "failed",
    "page": 1,
    "page_size": 20
}

response = requests.get(url, headers=headers, params=params)
data = response.json()

print(f"Total de registros: {data['metadata']['total_records']}")
for log in data['data']:
    print(f"[{log['timestamp']}] {log['model']} - Status: {log['status']}")
```

---

## Valida√ß√£o de Integridade com payload_hash

O campo `payload_hash` cont√©m o hash SHA-256 do payload JSON original, permitindo verificar que dados enviados n√£o foram corrompidos ou alterados ap√≥s o envio.

### Como Validar Integridade

```python
import hashlib
import json

# Payload original enviado
payload = {
    "cnpj": "12.345.678/0001-95",
    "razao_social": "Distribuidora XYZ Ltda",
    "email": "contato@xyzfarma.com.br",
    "status": "ACTIVE"
}

# Calcular hash SHA-256
payload_json = json.dumps(payload, sort_keys=True, separators=(',', ':'))
hash_calculado = hashlib.sha256(payload_json.encode('utf-8')).hexdigest()

print(f"Hash calculado: {hash_calculado}")

# Comparar com payload_hash retornado pelo Audit Log API
# Se forem iguais, payload est√° √≠ntegro
```

<Warning>
‚ö†Ô∏è **Serializa√ß√£o Consistente**: Hash √© calculado sobre JSON serializado com `sort_keys=True` - certifique-se de usar a mesma serializa√ß√£o ao validar.
</Warning>

<Tip>
üí° **Compliance**: `payload_hash` √© √∫til para auditorias - prove que dados n√£o foram alterados ap√≥s envio.
</Tip>

---

## Casos de Uso

<AccordionGroup>
  <Accordion title="üîç Debugar Falhas de Integra√ß√£o" icon="bug">
    **Cen√°rio**: Voc√™ nota que alguns dados n√£o aparecem no Data Lake.

    **Solu√ß√£o**:
    1. Consultar Audit Log filtrando `status=failed`
    2. Identificar registros com falha
    3. Ler mensagem de erro (se dispon√≠vel)
    4. Corrigir payload e reenviar

    **Exemplo**:
    ```bash
    curl -X GET "https://api-sandbox.nexfar.com.br/api/v1/audit-log?status=failed&date_from=2025-11-01" \
      -H "Authorization: Bearer TOKEN"
    ```
  </Accordion>

  <Accordion title="‚úÖ Confirmar Dados Foram Enviados" icon="check">
    **Cen√°rio**: Voc√™ enviou dados mas quer confirmar que foram recebidos.

    **Solu√ß√£o**:
    1. Usar `correlation_id` retornado na resposta da ingest√£o
    2. Consultar Audit Log filtrando por modelo e per√≠odo
    3. Verificar `status=processed`

    **Exemplo**:
    ```bash
    curl -X GET "https://api-sandbox.nexfar.com.br/api/v1/audit-log?model=client&date_from=2025-11-08" \
      -H "Authorization: Bearer TOKEN"
    ```
  </Accordion>

  <Accordion title="üîê Validar Integridade de Dados" icon="shield">
    **Cen√°rio**: Auditoria interna requer prova de que dados n√£o foram alterados.

    **Solu√ß√£o**:
    1. Calcular hash SHA-256 do payload original
    2. Consultar Audit Log e comparar com `payload_hash`
    3. Se hashes forem iguais, dados est√£o √≠ntegros

    Ver se√ß√£o **"Valida√ß√£o de Integridade com payload_hash"** acima.
  </Accordion>

  <Accordion title="üìä Auditar Envios Mensais" icon="chart-simple">
    **Cen√°rio**: Gerar relat√≥rio mensal de ingest√µes para compliance.

    **Solu√ß√£o**:
    1. Consultar Audit Log com `date_from` e `date_to` do m√™s
    2. Iterar por todas as p√°ginas (`page=1, 2, 3...`)
    3. Exportar para CSV ou JSON
    4. Analisar total de envios, taxa de falha, modelos mais enviados

    **Exemplo**:
    ```bash
    curl -X GET "https://api-sandbox.nexfar.com.br/api/v1/audit-log?date_from=2025-11-01&date_to=2025-11-30&page_size=100" \
      -H "Authorization: Bearer TOKEN"
    ```
  </Accordion>

  <Accordion title="üìà Rastrear Envios GraphQL vs REST" icon="code-compare">
    **Cen√°rio**: Comparar uso de GraphQL vs REST pela sua equipe.

    **Solu√ß√£o**:
    1. Consultar Audit Log sem filtros
    2. Analisar campo `endpoint`:
       - Endpoints iniciando com `/api/v1/` ‚Üí REST
       - Endpoints `/graphql` ‚Üí GraphQL
    3. Agrupar por endpoint e contar

    **Exemplo Python**:
    ```python
    logs = response.json()['data']
    rest_count = sum(1 for log in logs if log['endpoint'].startswith('/api/v1/'))
    graphql_count = sum(1 for log in logs if log['endpoint'] == '/graphql')
    print(f"REST: {rest_count}, GraphQL: {graphql_count}")
    ```
  </Accordion>
</AccordionGroup>

---

## Troubleshooting

<AccordionGroup>
  <Accordion title="‚ùå Erro 401 Unauthorized" icon="lock">
    **Causas**:
    - Token JWT ausente ou inv√°lido
    - Token expirado

    **Solu√ß√µes**:
    1. Verificar header `Authorization: Bearer {token}`
    2. Validar token em [jwt.io](https://jwt.io) (verificar campo `exp`)
    3. Solicitar novo token se expirado

    **Documenta√ß√£o**: [Autentica√ß√£o JWT](/integration/api-ingestion/authentication)
  </Accordion>

  <Accordion title="‚ùå Erro 400 Bad Request - Query parameter inv√°lido" icon="triangle-exclamation">
    **Erro Comum**: `date_from deve ser anterior a date_to`

    **Causas**:
    - Formato de data incorreto
    - Par√¢metro com valor inv√°lido
    - `date_from` maior que `date_to`

    **Solu√ß√µes**:
    1. Usar formato ISO 8601: `YYYY-MM-DD` ou `YYYY-MM-DDTHH:mm:ssZ`
    2. Validar valores de enum (status: `received`/`processed`/`failed`)
    3. Conferir tabela de query parameters acima
  </Accordion>

  <Accordion title="‚ùå Resposta vazia (data: [])" icon="inbox">
    **Causas**:
    - Nenhum registro corresponde aos filtros
    - Per√≠odo de data sem ingest√µes
    - `client_id` do JWT n√£o tem registros

    **Solu√ß√µes**:
    1. Ampliar per√≠odo: remover `date_from` e `date_to`
    2. Remover filtros `status` e `model`
    3. Verificar se enviou dados recentemente
    4. Confirmar ambiente correto (sandbox vs production)
  </Accordion>

  <Accordion title="‚úÖ Como paginar corretamente?" icon="book">
    **Uso de pagina√ß√£o**:
    1. Primeira requisi√ß√£o: `?page=1&page_size=50`
    2. Verificar `metadata.current_page` e `metadata.total_pages` na resposta
    3. Se `current_page < total_pages`, fazer pr√≥xima requisi√ß√£o: `?page=2`
    4. Repetir at√© `current_page == total_pages`

    **Exemplo Python**:
    ```python
    page = 1
    all_logs = []
    while True:
        response = requests.get(url, headers=headers, params={"page": page, "page_size": 50})
        data = response.json()
        all_logs.extend(data['data'])

        if data['metadata']['current_page'] >= data['metadata']['total_pages']:
            break
        page += 1

    print(f"Total de logs recuperados: {len(all_logs)}")
    ```
  </Accordion>
</AccordionGroup>

---

## Ambientes: Sandbox vs Production

| Aspecto | Sandbox | Production |
|---------|---------|------------|
| **URL** | `https://api-sandbox.nexfar.com.br/api/v1/audit-log` | `https://api.nexfar.com.br/api/v1/audit-log` |
| **Dados** | Dados de teste, podem ser deletados ap√≥s 30 dias | Dados reais, armazenados permanentemente |
| **Reten√ß√£o** | 30 dias (limpeza autom√°tica) | Permanente (conforme pol√≠tica de reten√ß√£o) |
| **Isolamento** | Isolado logicamente via JWT claim `environment=sandbox` | Isolado via JWT claim `environment=production` |

<Warning>
‚ö†Ô∏è **Logs do Sandbox s√£o deletados automaticamente ap√≥s 30 dias** - exporte dados importantes antes da expira√ß√£o.
</Warning>

<Note>
üìù **Mesmo JWT token funciona em ambos os ambientes** - isolamento √© autom√°tico via claim `environment`.
</Note>

**Documenta√ß√£o**: [Ambientes: Sandbox vs Production](/integration/api-ingestion/environments)

---

## Pr√≥ximos Passos

<CardGroup cols={2}>
  <Card title="Quick Start" icon="rocket" href="/integration/api-ingestion/quickstart">
    Come√ßar a enviar dados rapidamente
  </Card>

  <Card title="Autentica√ß√£o JWT" icon="key" href="/integration/api-ingestion/authentication">
    Entenda tokens JWT e claims
  </Card>

  <Card title="GraphQL" icon="diagram-project" href="/integration/api-ingestion/graphql">
    Consulte hist√≥rico de mutations GraphQL
  </Card>

  <Card title="Troubleshooting" icon="wrench" href="/integration/api-ingestion/troubleshooting">
    Resolva problemas comuns
  </Card>
</CardGroup>

### Recursos Adicionais

- [API Reference OpenAPI](/integration/api-reference) - Documenta√ß√£o completa REST API
- [Ambientes: Sandbox vs Production](/integration/api-ingestion/environments) - Diferen√ßas entre ambientes
- [Vis√£o Geral da API](/integration/api-ingestion/overview) - Conceitos fundamentais
