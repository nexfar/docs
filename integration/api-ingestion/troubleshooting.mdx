---
title: "Troubleshooting Guide"
description: "Guia completo de resolu√ß√£o de problemas da API de Ingest√£o Nexfar. Solucione erros 400, 401, 403, 429, 500, 503 de forma aut√¥noma. Checklist para dados ausentes, valida√ß√£o CNPJ/email."
icon: "life-ring"
---

# Troubleshooting Guide

Erros s√£o uma parte normal do processo de integra√ß√£o com qualquer API. A boa not√≠cia √© que **mais de 90% dos problemas comuns podem ser resolvidos de forma aut√¥noma** com este guia.

Nesta p√°gina voc√™ encontrar√°:
- **Erros HTTP comuns** (400, 401, 403, 429, 500, 503) com solu√ß√µes passo-a-passo
- **Checklist investigativo** para quando dados n√£o aparecem no Data Lake
- **Exemplos pr√°ticos** de corre√ß√£o de erros de valida√ß√£o
- **Informa√ß√µes de contato** do suporte Nexfar caso precise de ajuda

<Note>
üìù Este guia cobre os problemas mais comuns. Se seu erro n√£o estiver listado, consulte a se√ß√£o de Contato de Suporte ao final.
</Note>

<Tip>
üí° Sempre teste corre√ß√µes no ambiente Sandbox antes de aplicar em Produ√ß√£o - isso evita impacto em dados reais.
</Tip>

---

## Erros HTTP Comuns

<AccordionGroup>

<Accordion title="‚ùå 400 Bad Request - Requisi√ß√£o Inv√°lida">

### Causa Raiz

- Payload JSON malformado (syntax error)
- Campos obrigat√≥rios ausentes
- Tipos de dados incorretos (string ao inv√©s de n√∫mero)
- Formato de dados inv√°lido (CNPJ, email, CPF, data)
- Valores fora do range permitido (negativos, muito longos)

### Sintomas

- Resposta HTTP 400
- Body da resposta cont√©m array de mensagens de erro detalhadas

**Exemplo de resposta:**
```json
{
  "statusCode": 400,
  "message": [
    "cnpj must be a valid CNPJ",
    "email must be a valid email",
    "razao_social should not be empty"
  ],
  "error": "Bad Request"
}
```

### Solu√ß√£o Passo-a-Passo

1. Ler campo `message` da resposta - cont√©m lista de erros espec√≠ficos
2. Identificar campo problem√°tico mencionado na mensagem
3. Consultar [API Reference OpenAPI](/integration/api-reference) para ver formato esperado
4. Corrigir payload localmente
5. Testar no Sandbox antes de reenviar
6. Validar resposta 201 Created

### Exemplo de Corre√ß√£o - CNPJ Inv√°lido

```bash
# ‚ùå Erro: CNPJ sem formata√ß√£o
{
  "cnpj": "12345678000190",
  "razao_social": "Farm√°cia XYZ"
}

# ‚úÖ Correto: CNPJ formatado
{
  "cnpj": "12.345.678/0001-90",
  "razao_social": "Farm√°cia XYZ"
}
```

Veja mais exemplos na se√ß√£o [Erros de Valida√ß√£o Comuns](#erros-de-validacao-comuns) abaixo.

<Warning>
‚ö†Ô∏è Valide dados localmente ANTES de enviar - isso reduz drasticamente erros 400 e acelera integra√ß√£o.
</Warning>

</Accordion>

<Accordion title="üîí 401 Unauthorized - Autentica√ß√£o Falhou">

### Causa Raiz

- Token JWT ausente no header Authorization
- Token JWT expirado (campo `exp` no passado)
- Token JWT inv√°lido (assinatura incorreta ou corrompido)
- Header Authorization malformado (faltando "Bearer ")

### Sintomas

- Resposta HTTP 401
- Mensagem: "Unauthorized" ou "Token expired"
- Requisi√ß√£o rejeitada antes de validar payload

### Solu√ß√£o Passo-a-Passo

1. Verificar header `Authorization: Bearer {token}` est√° presente
2. Validar formato do token em [jwt.io](https://jwt.io) - cole token e verifique campos
3. Verificar campo `exp` (expiration) - se timestamp < agora, token expirou
4. Se expirado: Solicitar novo token JWT √† Nexfar via email/ticket
5. Atualizar vari√°vel de ambiente/config com novo token
6. Reenviar requisi√ß√£o

### Exemplo de Header Correto

```bash
# ‚ùå Erro: Faltando "Bearer "
curl -H "Authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  https://ingestion.nexfar.com.br/api/v1/clients

# ‚úÖ Correto: Incluir "Bearer "
curl -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  https://ingestion.nexfar.com.br/api/v1/clients
```

### Como Verificar Expira√ß√£o do Token

1. Acessar [jwt.io](https://jwt.io)
2. Colar token no campo "Encoded"
3. Verificar campo `exp` no JSON decodificado
4. Comparar `exp` (Unix timestamp) com timestamp atual
5. Se `exp` < agora ‚Üí token expirado

Consulte a [Documenta√ß√£o de Autentica√ß√£o JWT](/integration/api-ingestion/authentication) para mais detalhes.

<Tip>
üí° Tokens JWT t√™m validade limitada (geralmente 30-90 dias). Configure alertas para renovar tokens antes da expira√ß√£o.
</Tip>

</Accordion>

<Accordion title="üö´ 403 Forbidden - Acesso Negado">

### Causa Raiz

- Token JWT v√°lido mas sem permiss√µes (scopes) necess√°rias
- Tentativa de acessar recurso de outro cliente (isolamento por tenant_id)
- Tentativa de acessar dados de outro ambiente (sandbox tentando ver production)
- IP n√£o permitido (se houver whitelist configurada)

### Sintomas

- Resposta HTTP 403
- Mensagem: "Forbidden" ou "Insufficient permissions"
- Requisi√ß√£o autenticada (token v√°lido) mas rejeitada por falta de permiss√£o

### Solu√ß√£o Passo-a-Passo

1. Verificar claim `scopes` do JWT token em [jwt.io](https://jwt.io)
2. Confirmar que scope necess√°rio est√° presente (ex: `ingest:write`)
3. Se scope ausente: Solicitar atualiza√ß√£o de permiss√µes √† Nexfar
4. Verificar claim `environment` corresponde ao endpoint usado:
   - Token sandbox ‚Üí usar `ingestion.nexfar.com.br`
   - Token production ‚Üí usar `ingestion.nexfar.com.br`
5. Confirmar que `tenant_id` no token corresponde aos dados que est√° tentando acessar

### Exemplo - Ambiente Incorreto

```bash
# ‚ùå Erro: Token sandbox tentando acessar production
curl -H "Authorization: Bearer TOKEN_SANDBOX" \
  https://ingestion.nexfar.com.br/api/v1/clients  # URL production

# ‚úÖ Correto: Token sandbox com URL sandbox
curl -H "Authorization: Bearer TOKEN_SANDBOX" \
  https://ingestion.nexfar.com.br/api/v1/clients
```

Consulte a [Documenta√ß√£o de Ambientes](/integration/api-ingestion/environments) para entender melhor a separa√ß√£o entre Sandbox e Production.

<Warning>
‚ö†Ô∏è Isolamento por tenant_id √© autom√°tico - voc√™ nunca ver√° dados de outros clientes mesmo que tente. Isso garante seguran√ßa dos dados.
</Warning>

</Accordion>

<Accordion title="‚è±Ô∏è 429 Too Many Requests - Rate Limit Excedido">

### Causa Raiz

- N√∫mero de requisi√ß√µes excedeu limite configurado (100 req/min por tenant_id)
- M√∫ltiplos processos enviando dados simultaneamente sem coordena√ß√£o
- Loop infinito de retry sem backoff

### Sintomas

- Resposta HTTP 429
- Header `Retry-After` indica segundos para aguardar
- Mensagem: "Too Many Requests" ou "Rate limit exceeded"

### Solu√ß√£o Passo-a-Passo

1. Ler header `Retry-After` da resposta (indica tempo de espera em segundos)
2. Aguardar tempo indicado antes de reenviar
3. Implementar exponential backoff nos retries (1s, 5s, 25s)
4. Se problema persistir: Reduzir taxa de envio ou solicitar aumento de limite √† Nexfar
5. Considerar batching de requisi√ß√µes (agrupar m√∫ltiplos registros)

### Exemplo de Retry com Backoff (Python)

```python
import requests
import time

def enviar_com_retry(url, headers, payload, max_retries=3):
    for tentativa in range(max_retries):
        response = requests.post(url, json=payload, headers=headers)

        if response.status_code == 201:
            return response.json()  # Sucesso

        elif response.status_code == 429:
            retry_after = int(response.headers.get('Retry-After', 60))
            print(f"Rate limit excedido. Aguardando {retry_after}s...")
            time.sleep(retry_after)

        else:
            # Erro diferente, n√£o retenta
            response.raise_for_status()

    raise Exception("Max retries excedido")
```

<Tip>
üí° Rate limit √© por tenant_id, n√£o por processo. Coordene envios entre m√∫ltiplas inst√¢ncias da sua aplica√ß√£o para evitar 429.
</Tip>

<Note>
üìù Limite padr√£o: 100 requisi√ß√µes/minuto por tenant_id. Para aumento de limite, contate suporte Nexfar com justificativa de volume.
</Note>

</Accordion>

<Accordion title="üîß 500 Internal Server Error - Erro no Servidor">

### Causa Raiz

- Erro inesperado no backend da API Nexfar
- Timeout de conex√£o com banco de dados
- Bug no c√≥digo do servidor (raro ap√≥s MVP)
- Payload v√°lido mas causou erro de processamento n√£o previsto

### Sintomas

- Resposta HTTP 500
- Mensagem gen√©rica: "Internal Server Error"
- Corpo da resposta pode conter `correlation_id` para rastreamento

### Solu√ß√£o Passo-a-Passo

1. Salvar `correlation_id` da resposta (campo no JSON de erro)
2. Aguardar 5-10 minutos e tentar novamente (pode ser timeout tempor√°rio)
3. Se erro persistir com mesmo payload: N√ÉO √© problema no seu lado
4. Consultar [Audit Log API](/integration/api-ingestion/audit-log) com `correlation_id` para ver detalhes
5. Contatar suporte Nexfar informando:
   - `correlation_id`
   - Timestamp do erro
   - Endpoint utilizado
   - Payload enviado (sanitizado - remover dados sens√≠veis)
6. Aguardar corre√ß√£o da Nexfar (SLA de resposta: 24h em dias √∫teis)

### Exemplo de Resposta 500

```json
{
  "statusCode": 500,
  "message": "Internal Server Error",
  "correlation_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

Consulte a se√ß√£o [Contato de Suporte](#contato-de-suporte) ao final para informa√ß√µes de como reportar o erro.

<Warning>
‚ö†Ô∏è Erros 500 N√ÉO s√£o culpa do cliente - sempre indicam problema no backend. Guarde correlation_id para rastreamento.
</Warning>

<Note>
üìù Se erro 500 ocorre consistentemente com payload espec√≠fico, pode indicar bug. Reporte com correlation_id e payload para corre√ß√£o priorit√°ria.
</Note>

</Accordion>

<Accordion title="‚öôÔ∏è 503 Service Unavailable - Servi√ßo Temporariamente Indispon√≠vel">

### Causa Raiz

- Manuten√ß√£o programada da API (rara, comunicada com anteced√™ncia)
- Deploy de nova vers√£o em andamento
- Sobrecarga tempor√°ria do sistema
- Falha de infraestrutura (banco de dados inacess√≠vel)

### Sintomas

- Resposta HTTP 503
- Mensagem: "Service Unavailable" ou "Temporarily Unavailable"
- Header `Retry-After` pode indicar tempo estimado de retorno

### Solu√ß√£o Passo-a-Passo

1. Verificar header `Retry-After` (tempo em segundos para retry)
2. Aguardar tempo indicado (geralmente 1-5 minutos)
3. Implementar retry autom√°tico com exponential backoff
4. Se erro persistir > 10 minutos: Verificar status page da Nexfar (se existir)
5. Contatar suporte Nexfar se indisponibilidade prolongada

### Exemplo de Retry Autom√°tico (Python)

```python
import requests
import time

def enviar_com_retry_503(url, headers, payload):
    max_retries = 5
    backoff = [1, 5, 10, 30, 60]  # segundos

    for i, wait_time in enumerate(backoff):
        response = requests.post(url, json=payload, headers=headers)

        if response.status_code == 201:
            return response.json()  # Sucesso

        elif response.status_code == 503:
            if i < max_retries - 1:
                print(f"Servi√ßo indispon√≠vel. Retry {i+1}/{max_retries} em {wait_time}s...")
                time.sleep(wait_time)
            else:
                raise Exception("Servi√ßo ainda indispon√≠vel ap√≥s m√∫ltiplos retries")

        else:
            response.raise_for_status()
```

<Tip>
üí° Erros 503 s√£o geralmente tempor√°rios (< 5 minutos). Implemente retry autom√°tico para resili√™ncia.
</Tip>

<Note>
üìù Manuten√ß√µes programadas s√£o comunicadas com 48h de anteced√™ncia via email. Agende suas cargas fora desses per√≠odos.
</Note>

</Accordion>

</AccordionGroup>

---

## üîç Dados N√£o Aparecem no Data Lake - Checklist Investigativo

Se voc√™ enviou dados, recebeu **201 Created**, mas dados n√£o aparecem no Data Lake da Nexfar, siga este checklist:

1. **‚úÖ Confirmar resposta 201 Created**: Requisi√ß√£o retornou sucesso? Se 400/401/500, dados n√£o foram aceitos.

2. **‚úÖ Verificar correlation_id**: Salve `correlation_id` da resposta e consulte [Audit Log API](/integration/api-ingestion/audit-log)

3. **‚úÖ Consultar Audit Log**: Use `?correlation_id=UUID` para ver se registro foi criado com `status=processed`

4. **‚úÖ Validar ambiente correto**: Enviou para Sandbox mas est√° consultando Produ√ß√£o (ou vice-versa)? Ambientes s√£o isolados.

5. **‚úÖ Aguardar processamento**: Em casos raros, processamento pode levar 1-5 minutos. Aguarde e consulte novamente.

6. **‚úÖ Verificar tenant_id**: Token JWT corresponde ao cliente correto? Dados s√£o isolados por tenant_id.

7. **‚úÖ Confirmar modelo correto**: Est√° consultando tabela/view correto no Data Lake? (ex: enviou `client`, consultando `clients`)

8. **‚úÖ Validar reten√ß√£o Sandbox**: Se Sandbox, dados > 30 dias s√£o deletados automaticamente ([Ambientes](/integration/api-ingestion/environments))

<Warning>
‚ö†Ô∏è CR√çTICO: Sandbox deleta dados ap√≥s 30 dias. Se precisa dados persistentes, use ambiente Production.
</Warning>

### Se Checklist N√£o Resolver

Contatar suporte Nexfar com:
- `correlation_id` do envio
- Timestamp da requisi√ß√£o
- Endpoint utilizado
- Ambiente (Sandbox/Production)
- Screenshot do Audit Log mostrando `status=processed`

Consulte o [Quick Start Guide](/integration/api-ingestion/quickstart) para validar que est√° seguindo o fluxo correto de integra√ß√£o.

---

## üìã Erros de Valida√ß√£o Comuns - Exemplos Pr√°ticos

Erros **400 Bad Request** geralmente indicam problema de valida√ß√£o. Veja os casos mais comuns e como corrigir:

<AccordionGroup>

<Accordion title="CNPJ Inv√°lido">

**Causa:** CNPJ sem formata√ß√£o correta ou d√≠gito verificador errado

**Formato esperado:** `XX.XXX.XXX/XXXX-XX`

**Exemplo de erro:**
```json
{
  "statusCode": 400,
  "message": ["cnpj must be a valid CNPJ"],
  "error": "Bad Request"
}
```

**Solu√ß√£o:**
```bash
# ‚ùå Errado
{ "cnpj": "12345678000190" }

# ‚úÖ Correto
{ "cnpj": "12.345.678/0001-90" }
```

**Validador online:** [Receita Federal](https://solucoes.receita.fazenda.gov.br/Servicos/cnpjreva/Cnpjreva_Solicitacao.asp)

</Accordion>

<Accordion title="Email Inv√°lido">

**Causa:** Email malformado (falta @, dom√≠nio inv√°lido)

**Formato esperado:** `usuario@dominio.com`

**Exemplo de erro:**
```json
{
  "statusCode": 400,
  "message": ["email must be a valid email"],
  "error": "Bad Request"
}
```

**Solu√ß√£o:**
```bash
# ‚ùå Errado
{ "email": "contato@" }
{ "email": "contato" }

# ‚úÖ Correto
{ "email": "contato@farmacia.com.br" }
```

</Accordion>

<Accordion title="CPF Inv√°lido">

**Causa:** CPF sem formata√ß√£o ou d√≠gito verificador errado

**Formato esperado:** `XXX.XXX.XXX-XX`

**Exemplo de erro:**
```json
{
  "statusCode": 400,
  "message": ["cpf must be a valid CPF"],
  "error": "Bad Request"
}
```

**Solu√ß√£o:**
```bash
# ‚ùå Errado
{ "cpf": "12345678900" }

# ‚úÖ Correto
{ "cpf": "123.456.789-00" }
```

</Accordion>

<Accordion title="Campo Obrigat√≥rio Ausente">

**Causa:** Campo marcado como obrigat√≥rio n√£o foi enviado

**Exemplo de erro:**
```json
{
  "statusCode": 400,
  "message": [
    "razao_social should not be empty",
    "cnpj should not be empty"
  ],
  "error": "Bad Request"
}
```

**Solu√ß√£o:** Consultar [API Reference](/integration/api-reference) para ver campos obrigat√≥rios do modelo e adicionar campos faltantes ao payload.

</Accordion>

<Accordion title="Valor Negativo N√£o Permitido">

**Causa:** Campo num√©rico (pre√ßo, quantidade) com valor negativo

**Exemplo de erro:**
```json
{
  "statusCode": 400,
  "message": ["price must be a positive number"],
  "error": "Bad Request"
}
```

**Solu√ß√£o:**
```bash
# ‚ùå Errado
{ "price": -10.50 }

# ‚úÖ Correto
{ "price": 10.50 }
```

</Accordion>

<Accordion title="Tipo de Dado Incorreto">

**Causa:** Enviou string ao inv√©s de n√∫mero (ou vice-versa)

**Exemplo de erro:**
```json
{
  "statusCode": 400,
  "message": ["quantity must be a number conforming to the specified constraints"],
  "error": "Bad Request"
}
```

**Solu√ß√£o:**
```bash
# ‚ùå Errado (n√∫mero como string)
{ "quantity": "10" }

# ‚úÖ Correto (n√∫mero)
{ "quantity": 10 }
```

</Accordion>

</AccordionGroup>

<Tip>
üí° Use biblioteca de valida√ß√£o localmente (ex: Python `validate_docbr`, JS `cpf-cnpj-validator`) antes de enviar para API - isso reduz 80%+ dos erros 400.
</Tip>

---

## Documenta√ß√£o Relacionada

<CardGroup cols={2}>

<Card title="Quick Start" icon="rocket" href="/integration/api-ingestion/quickstart">
  Validar fluxo correto de integra√ß√£o
</Card>

<Card title="Autentica√ß√£o JWT" icon="lock" href="/integration/api-ingestion/authentication">
  Resolver erros 401 e 403
</Card>

<Card title="Audit Log API" icon="clock-rotate-left" href="/integration/api-ingestion/audit-log">
  Rastrear envios e debugar falhas
</Card>

<Card title="Ambientes" icon="server" href="/integration/api-ingestion/environments">
  Entender Sandbox vs Production
</Card>

</CardGroup>

---

## üìû Contato de Suporte Nexfar

Se ap√≥s seguir este guia o problema persistir, entre em contato com o suporte t√©cnico da Nexfar:

<Note>
üìù Para agilizar atendimento, sempre inclua: `correlation_id`, timestamp do erro, endpoint utilizado, e descri√ß√£o do problema.
</Note>

### Canais de Suporte

- **Email:** suporte@nexfar.com.br (SLA resposta: 24h em dias √∫teis)
- **Ticket:** [Portal de Suporte](https://suporte.nexfar.com.br) (requer login)
- **Telefone:** +55 (11) XXXX-XXXX (hor√°rio: 9h-18h BRT)

### Informa√ß√µes Necess√°rias ao Contatar Suporte

1. Correlation ID (`correlation_id` da resposta de erro)
2. Timestamp do erro (data/hora exato da requisi√ß√£o)
3. Endpoint utilizado (ex: `POST /api/v1/clients`)
4. Ambiente (Sandbox ou Production)
5. C√≥digo HTTP do erro (400, 401, 500, etc)
6. Mensagem de erro completa (campo `message` da resposta)
7. Payload enviado (sanitizado - remover dados sens√≠veis como credenciais)
8. Evid√™ncias: Screenshots do Audit Log ou logs locais

<Warning>
‚ö†Ô∏è NUNCA compartilhe seu token JWT completo com suporte. Se necess√°rio validar token, compartilhe apenas √∫ltimos 8 caracteres.
</Warning>

### SLA de Atendimento

- **Prioridade Alta** (Produ√ß√£o parada): 4h
- **Prioridade M√©dia** (Erros intermitentes): 24h
- **Prioridade Baixa** (D√∫vidas, melhorias): 72h
