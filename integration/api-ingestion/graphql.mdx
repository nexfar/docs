---
title: "GraphQL - Schema e Exemplos"
description: "Documenta√ß√£o completa do GraphQL API da Nexfar: schema SDL, mutations para todos os 34 modelos, autentica√ß√£o JWT, e exemplos pr√°ticos. Use GraphQL para queries flex√≠veis e tipagem forte."
icon: "graphql"
---

## Introdu√ß√£o

A API de Ingest√£o da Nexfar est√° dispon√≠vel em duas interfaces complementares: **REST** e **GraphQL**. Ambas compartilham a mesma autentica√ß√£o JWT, os mesmos ambientes (Sandbox/Produ√ß√£o), e os mesmos 34 modelos de dados.

GraphQL oferece uma alternativa poderosa para desenvolvedores que preferem queries flex√≠veis, tipagem forte, e explora√ß√£o interativa do schema. Esta p√°gina documenta o GraphQL API completo, incluindo mutations para todos os 34 modelos, configura√ß√£o de autentica√ß√£o, e exemplos pr√°ticos.

## Por que usar GraphQL?

GraphQL e REST n√£o s√£o mutuamente exclusivos - voc√™ pode usar ambos no mesmo projeto. Escolha baseado nas necessidades espec√≠ficas de cada caso de uso.

| Aspecto | REST | GraphQL |
|---------|------|---------|
| **Queries** | Endpoints fixos, retorna todos os campos | Query flex√≠vel, retorna apenas campos solicitados |
| **M√∫ltiplos Recursos** | M√∫ltiplas requisi√ß√µes (N+1 problem) | Uma requisi√ß√£o, m√∫ltiplos recursos |
| **Tipagem** | Documenta√ß√£o separada (OpenAPI) | Schema SDL com tipos introspect√°veis |
| **Explora√ß√£o** | Swagger UI, leitura de docs | GraphQL Playground com autocompletar |
| **Versionamento** | URLs versionadas (/api/v1, /api/v2) | Schema evolui sem breaking changes |
| **Overhead** | Simples, menos metadados | Mais verboso, mas mais flex√≠vel |
| **Cache HTTP** | Nativo (GET requests) | Requer Apollo Cache ou similar |
| **Uploads** | Multipart/form-data nativo | Requer extens√£o (graphql-upload) |

<Note>
**üìù Ambos REST e GraphQL est√£o dispon√≠veis** - escolha baseado nas necessidades do seu projeto. REST √© √≥timo para opera√ß√µes CRUD simples, GraphQL brilha quando voc√™ precisa de flexibilidade.
</Note>

<Tip>
**üí° GraphQL √© especialmente √∫til** para desenvolvedores que preferem tipagem forte e autocompletar no IDE (TypeScript/Codegen)
</Tip>

## GraphQL Playground Interativo

O **GraphQL Playground** √© uma interface web interativa para explorar o schema e testar mutations em tempo real. Ele oferece autocompletar, documenta√ß√£o integrada, e valida√ß√£o de tipos autom√°tica.

**URLs do Playground:**

- **Sandbox:** `https://api-sandbox.nexfar.com.br/graphql`
- **Staging:** `https://nf-nest-integration-staging.up.railway.app/graphql`

<Warning>
‚ö†Ô∏è **GraphQL Playground est√° habilitado apenas em Sandbox e Staging**. Em Produ√ß√£o, use cliente GraphQL program√°tico (Apollo Client, urql, etc.)
</Warning>

### Como configurar autentica√ß√£o no Playground

<Steps>
  <Step title="Abrir GraphQL Playground">
    Acesse: `https://api-sandbox.nexfar.com.br/graphql` (Sandbox)
  </Step>

  <Step title="Configurar Header JWT">
    Clique na aba **"HTTP HEADERS"** (canto inferior esquerdo) e adicione:

    ```json
    {
      "Authorization": "Bearer SEU_TOKEN_JWT_AQUI"
    }
    ```
  </Step>

  <Step title="Executar Mutation de Teste">
    Execute uma mutation simples (ex: `createClient`) para validar autentica√ß√£o.
  </Step>

  <Step title="Validar Resposta">
    - ‚úÖ Se autenticado: resposta `201 Created` com `correlation_id`
    - ‚ùå Se token inv√°lido: erro `401 Unauthorized`
  </Step>
</Steps>

<Tip>
üí° **Use a aba 'HTTP HEADERS' no canto inferior esquerdo** do Playground para adicionar o token JWT
</Tip>

## Modelos Dispon√≠veis (34 Types)

Todos os 34 modelos de dados possuem mutations GraphQL correspondentes. Abaixo est√£o os modelos organizados por categoria:

<AccordionGroup>

<Accordion title="Cadastros B√°sicos (5 modelos)">
  - **Client** (Cliente)
  - **Seller** (Vendedor)
  - **PaymentCondition** (Condi√ß√£o de Pagamento)
  - **PriceGroup** (Grupo de Pre√ßo)
  - **ClientBranch** (Filial de Cliente)

  **üìù Todos os types possuem mutations correspondentes:** `createClient`, `createSeller`, `createPaymentCondition`, `createPriceGroup`, `createClientBranch`
</Accordion>

<Accordion title="Produtos (8 modelos)">
  - **Product** (Produto)
  - **ProductBranch** (Produto por Filial)
  - **ProductWarehouse** (Produto por Armaz√©m)
  - **ProductPrice** (Pre√ßo de Produto)
  - **ProductPmcPf** (PMC/PF de Produto)
  - **ProductRestriction** (Restri√ß√£o de Produto)
  - **ProductSaleNotAllowed** (Venda N√£o Permitida)
  - **ClientDocument** (Documento de Cliente)

  **üìù Mutations:** `createProduct`, `createProductBranch`, `createProductWarehouse`, `createProductPrice`, `createProductPmcPf`, `createProductRestriction`, `createProductSaleNotAllowed`, `createClientDocument`
</Accordion>

<Accordion title="Pedidos e Vendas (10 modelos)">
  - **Invoice** (Nota Fiscal)
  - **OrderHeader** (Cabe√ßalho de Pedido)
  - **OrderItem** (Item de Pedido)
  - **OrderReturnedItem** (Item Devolvido)
  - **OrderDistributorHeader** (Cabe√ßalho Pedido Distribuidor)
  - **OrderDistributorItem** (Item Pedido Distribuidor)
  - **SaleHeader** (Cabe√ßalho de Venda)
  - **SaleItem** (Item de Venda)
  - **SaleClient** (Venda por Cliente)
  - **SaleSeller** (Venda por Vendedor)

  **üìù Mutations:** `createInvoice`, `createOrderHeader`, `createOrderItem`, `createOrderReturnedItem`, `createOrderDistributorHeader`, `createOrderDistributorItem`, `createSaleHeader`, `createSaleItem`, `createSaleClient`, `createSaleSeller`
</Accordion>

<Accordion title="Impostos, Margens e Metas (7 modelos)">
  - **SalesGoal** (Meta de Vendas)
  - **GenericMarginDetermination** (Determina√ß√£o de Margem)
  - **GenericMargin** (Margem Gen√©rica)
  - **GenericTaxesDetermination** (Determina√ß√£o de Impostos)
  - **GenericTaxes** (Impostos Gen√©ricos)
  - **GenericTaxesBaseCalcSt** (Base de C√°lculo ST)
  - **GenericExtraInfo** (Informa√ß√£o Extra)

  **üìù Mutations:** `createSalesGoal`, `createGenericMarginDetermination`, `createGenericMargin`, `createGenericTaxesDetermination`, `createGenericTaxes`, `createGenericTaxesBaseCalcSt`, `createGenericExtraInfo`
</Accordion>

<Accordion title="Combos (4 modelos)">
  - **ComboHeader** (Cabe√ßalho de Combo)
  - **ComboItem** (Item de Combo)
  - **ComboClient** (Cliente de Combo)
  - **ComboSeller** (Vendedor de Combo)

  **üìù Mutations:** `createComboHeader`, `createComboItem`, `createComboClient`, `createComboSeller`
</Accordion>

</AccordionGroup>

## Exemplos de Mutations

Todas as mutations retornam o tipo `IngestionResponseType`, que cont√©m informa√ß√µes sobre a ingest√£o criada.

### Criar Cliente (`createClient`)

```graphql
mutation CreateClient {
  createClient(input: {
    cnpj: "12.345.678/0001-95"
    razao_social: "Distribuidora XYZ Ltda"
    nome_fantasia: "XYZ Farma"
    email: "contato@xyzfarma.com.br"
    telefone: "(11) 98765-4321"
    status: ACTIVE
  }) {
    id
    model
    message
    created_at
    correlation_id
  }
}
```

**Resposta esperada:**

```json
{
  "data": {
    "createClient": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "model": "client",
      "message": "Cliente criado com sucesso",
      "created_at": "2025-11-10T14:30:00Z",
      "correlation_id": "550e8400-e29b-41d4-a716-446655440000"
    }
  }
}
```

**Campos da resposta `IngestionResponseType`:**

- **`id`**: ID √∫nico da ingest√£o (UUID)
- **`model`**: Nome do modelo ingerido (ex: "client")
- **`message`**: Mensagem de confirma√ß√£o
- **`created_at`**: Timestamp da cria√ß√£o (ISO 8601)
- **`correlation_id`**: ID para rastreamento no Audit Log

### Criar Produto (`createProduct`)

```graphql
mutation CreateProduct {
  createProduct(input: {
    codigo_produto: "PROD-12345"
    descricao_produto: "Paracetamol 500mg - Caixa com 20 comprimidos"
    categoria: "MEDICAMENTO"
    preco_base: 15.50
    ativo: true
  }) {
    id
    model
    message
    created_at
    correlation_id
  }
}
```

### Criar Nota Fiscal (`createInvoice`)

```graphql
mutation CreateInvoice {
  createInvoice(input: {
    numero_nf: "NF-2025-12345"
    serie_nf: "001"
    data_emissao: "2025-11-08T10:00:00Z"
    codigo_cliente: "CLI-001"
    valor_total: 3200.00
    status: ISSUED
  }) {
    id
    model
    message
    created_at
    correlation_id
  }
}
```

<Tip>
üí° **Use a aba 'Docs' no GraphQL Playground** para explorar todos os inputs dispon√≠veis para cada mutation
</Tip>

<Tip>
üí° **GraphQL valida tipos automaticamente** - se voc√™ enviar campo obrigat√≥rio faltando, receber√° erro antes mesmo da requisi√ß√£o
</Tip>

## Autentica√ß√£o JWT no GraphQL

GraphQL usa a mesma autentica√ß√£o JWT que a REST API. Para mais detalhes sobre tokens JWT e claims, veja [Autentica√ß√£o JWT](/integration/api-ingestion/authentication).

### Configura√ß√£o no GraphQL Playground

Siga os passos abaixo para configurar autentica√ß√£o no Playground:

<Steps>
  <Step title="Abrir GraphQL Playground">
    Acesse: `https://api-sandbox.nexfar.com.br/graphql` (Sandbox)
  </Step>

  <Step title="Configurar Header JWT">
    Clique na aba **"HTTP HEADERS"** (canto inferior esquerdo) e adicione:

    ```json
    {
      "Authorization": "Bearer SEU_TOKEN_JWT_AQUI"
    }
    ```
  </Step>

  <Step title="Executar Mutation de Teste">
    Execute uma mutation simples (ex: `createClient`)
  </Step>

  <Step title="Validar Resposta">
    - ‚úÖ Se autenticado corretamente: resposta `201 Created`
    - ‚ùå Se token inv√°lido: erro `401 Unauthorized`
  </Step>
</Steps>

### Autentica√ß√£o em C√≥digo (Apollo Client - Node.js)

```typescript
import { ApolloClient, InMemoryCache, HttpLink, gql } from '@apollo/client';
import { setContext } from '@apollo/client/link/context';

const httpLink = new HttpLink({
  uri: 'https://api-sandbox.nexfar.com.br/graphql',
});

const authLink = setContext((_, { headers }) => {
  const token = process.env.NEXFAR_JWT_TOKEN;
  return {
    headers: {
      ...headers,
      authorization: token ? `Bearer ${token}` : '',
    },
  };
});

const client = new ApolloClient({
  link: authLink.concat(httpLink),
  cache: new InMemoryCache(),
});

// Exemplo de mutation
const { data } = await client.mutate({
  mutation: gql`
    mutation CreateClient($input: CreateClientInput!) {
      createClient(input: $input) {
        id
        model
        message
        correlation_id
      }
    }
  `,
  variables: {
    input: {
      cnpj: '12.345.678/0001-95',
      razao_social: 'Distribuidora XYZ Ltda',
      email: 'contato@xyzfarma.com.br',
      status: 'ACTIVE',
    },
  },
});

console.log(`Ingest√£o criada: ${data.createClient.id}`);
```

### Autentica√ß√£o em Python (gql library)

```python
from gql import gql, Client
from gql.transport.requests import RequestsHTTPTransport
import os

transport = RequestsHTTPTransport(
    url='https://api-sandbox.nexfar.com.br/graphql',
    headers={'Authorization': f'Bearer {os.getenv("NEXFAR_JWT_TOKEN")}'},
)

client = Client(transport=transport, fetch_schema_from_transport=True)

query = gql('''
    mutation CreateClient($input: CreateClientInput!) {
      createClient(input: $input) {
        id
        model
        message
        correlation_id
      }
    }
''')

variables = {
    'input': {
        'cnpj': '12.345.678/0001-95',
        'razao_social': 'Distribuidora XYZ Ltda',
        'email': 'contato@xyzfarma.com.br',
        'status': 'ACTIVE',
    }
}

result = client.execute(query, variable_values=variables)
print(f"Ingest√£o criada: {result['createClient']['id']}")
```

<Warning>
üîí **Nunca hardcode o token JWT no c√≥digo** - use vari√°veis de ambiente ou gerenciador de secrets
</Warning>

## Queries GraphQL (Consulta de Dados)

**Status Atual:** No MVP atual, GraphQL est√° focado em **mutations** (envio de dados). **Queries** para consulta de dados hist√≥ricos est√£o no roadmap.

<Note>
üìù **Para consultar hist√≥rico de envios**, use a [Audit Log API REST](/integration/api-ingestion/audit-log)
</Note>

<Note>
üìù **Queries GraphQL** para consulta de dados est√£o planejadas para vers√£o futura da API
</Note>

### Roadmap de Queries

Queries planejadas para futuras vers√µes:

- `clients(filter: {cnpj: String, status: ClientStatus}): [Client!]!`
- `products(filter: {codigo_produto: String, categoria: String}): [Product!]!`
- `invoices(filter: {numero_nf: String, date_from: String, date_to: String}): [Invoice!]!`
- `auditLogs(filter: {model: String, status: String, date_from: String}): [AuditLog!]!`

<Tip>
üí° **Se voc√™ precisa de queries GraphQL espec√≠ficas**, entre em contato com suporte@nexfar.com.br para discutir seu caso de uso
</Tip>

## Schema SDL Completo

O schema GraphQL √© gerado automaticamente pelo NestJS usando abordagem **code-first**. Voc√™ pode explorar o schema completo de v√°rias formas:

### Explorar Schema no Playground

1. Abra o GraphQL Playground: `https://api-sandbox.nexfar.com.br/graphql`
2. Clique na aba **"Schema"** (lado direito)
3. Navegue pelos types, inputs, mutations dispon√≠veis

### Gerar Schema Localmente (Introspection)

Voc√™ pode usar introspection para gerar o arquivo `schema.graphql` localmente:

```bash
# Usando graphql-cli
npm install -g graphql-cli
graphql get-schema --endpoint https://api-sandbox.nexfar.com.br/graphql \
  --header "Authorization: Bearer $NEXFAR_JWT_TOKEN" \
  --output schema.graphql
```

<Note>
üìù **Schema SDL √© atualizado automaticamente** quando novos types ou mutations s√£o adicionados
</Note>

## Quando Usar GraphQL vs REST?

### Use GraphQL Quando:

- ‚úÖ Voc√™ precisa de flexibilidade para selecionar campos espec√≠ficos (reduz payload)
- ‚úÖ Sua aplica√ß√£o precisa buscar m√∫ltiplos recursos em uma requisi√ß√£o
- ‚úÖ Voc√™ usa TypeScript e quer gerar types automaticamente (GraphQL Codegen)
- ‚úÖ Voc√™ prefere tipagem forte e valida√ß√£o de schema
- ‚úÖ Voc√™ quer explorar API interativamente com autocompletar (Playground)

### Use REST Quando:

- ‚úÖ Voc√™ prefere opera√ß√µes CRUD simples e diretas
- ‚úÖ Voc√™ quer aproveitar cache HTTP padr√£o (GET requests)
- ‚úÖ Voc√™ usa ferramentas que n√£o suportam GraphQL (ex: Postman b√°sico)
- ‚úÖ Sua equipe n√£o est√° familiarizada com GraphQL
- ‚úÖ Voc√™ precisa de uploads de arquivos grandes (multipart/form-data)

<Tip>
üí° **Voc√™ pode usar REST e GraphQL no mesmo projeto** - n√£o s√£o mutuamente exclusivos
</Tip>

## Troubleshooting GraphQL

<AccordionGroup>

<Accordion title="‚ùå Erro 401 Unauthorized no GraphQL">
  **Causas:**
  - Token JWT ausente, inv√°lido ou expirado

  **Solu√ß√µes:**
  1. Verificar header `Authorization: Bearer {token}` est√° configurado corretamente
  2. Validar token em jwt.io (verificar claim `exp` para expira√ß√£o)
  3. Confirmar que token tem scope `ingestion:write` ou `*`
  4. Testar token em endpoint REST primeiro (ex: POST /api/v1/clients) para isolar problema

  **Veja tamb√©m:** [Autentica√ß√£o JWT](/integration/api-ingestion/authentication) para mais detalhes
</Accordion>

<Accordion title="‚ùå Erro de valida√ß√£o de campo obrigat√≥rio">
  **Erro t√≠pico:**
  ```
  Field 'cnpj' of required type 'String!' was not provided
  ```

  **Causas:**
  - Campo obrigat√≥rio faltando ou tipo incorreto

  **Solu√ß√µes:**
  1. Verificar schema na aba 'Docs' do Playground (campos com `!` s√£o obrigat√≥rios)
  2. Validar tipo de dados (String vs Int vs Float vs Boolean vs Enum)
  3. Usar autocompletar do Playground para sugerir campos

  **Exemplo correto:**
  ```graphql
  input: {
    cnpj: "12.345.678/0001-95"  # String, obrigat√≥rio
    razao_social: "XYZ Ltda"      # String, obrigat√≥rio
    status: ACTIVE                # Enum ClientStatus, obrigat√≥rio
  }
  ```
</Accordion>

<Accordion title="‚ùå GraphQL Playground n√£o carrega">
  **Causas:**
  - Playground desabilitado em produ√ß√£o (por seguran√ßa)
  - URL incorreta
  - CORS bloqueando acesso

  **Solu√ß√µes:**
  1. Confirmar ambiente: Playground s√≥ est√° dispon√≠vel em Sandbox/Staging
  2. URL correta: `https://api-sandbox.nexfar.com.br/graphql` (Sandbox)
  3. Se em produ√ß√£o, use cliente GraphQL program√°tico (Apollo, urql)
  4. Testar endpoint com curl:
     ```bash
     curl -X POST https://api-sandbox.nexfar.com.br/graphql \
       -H "Authorization: Bearer $TOKEN" \
       -H "Content-Type: application/json" \
       -d '{"query":"{ __typename }"}'
     ```
</Accordion>

<Accordion title="‚úÖ Como validar que mutation foi bem-sucedida?">
  **Verificar resposta `IngestionResponseType`:**
  - `id`: ID √∫nico da ingest√£o (UUID)
  - `correlation_id`: Use para consultar Audit Log API
  - `message`: Confirma√ß√£o de sucesso (ex: "Cliente criado com sucesso")

  **Consultar Audit Log API para validar persist√™ncia:**
  ```bash
  curl -X GET "https://api-sandbox.nexfar.com.br/api/v1/audit-log?correlation_id={id}" \
    -H "Authorization: Bearer $TOKEN"
  ```

  **Veja tamb√©m:** [Audit Log API](/integration/api-ingestion/audit-log) para rastreabilidade completa
</Accordion>

</AccordionGroup>

## Pr√≥ximos Passos

<CardGroup cols={2}>
  <Card title="Explorar GraphQL Playground" icon="flask" href="https://api-sandbox.nexfar.com.br/graphql">
    Acesse o Playground interativo para testar mutations
  </Card>

  <Card title="Autentica√ß√£o JWT" icon="lock" href="/integration/api-ingestion/authentication">
    Aprenda sobre tokens JWT e claims
  </Card>

  <Card title="Rastreabilidade e Audit Log" icon="list-check" href="/integration/api-ingestion/audit-log">
    Consulte hist√≥rico de envios via REST API
  </Card>

  <Card title="Ambientes: Sandbox vs Produ√ß√£o" icon="flask-vial" href="/integration/api-ingestion/environments">
    Entenda os ambientes dispon√≠veis
  </Card>
</CardGroup>

## Recursos Adicionais

**Aprenda GraphQL:**
- [GraphQL Official Docs](https://graphql.org/learn/) - Aprenda GraphQL do zero
- [Apollo Client](https://www.apollographql.com/docs/react/) - Cliente GraphQL para React/Node.js
- [GraphQL Codegen](https://the-guild.dev/graphql/codegen) - Gere types TypeScript do schema
- [gql Python Library](https://github.com/graphql-python/gql) - Cliente GraphQL para Python

<Note>
üìù **GraphQL e REST compartilham mesma autentica√ß√£o JWT** e ambiente Sandbox/Produ√ß√£o
</Note>

<Note>
üìù **Todos os dados enviados via GraphQL aparecem no Audit Log** da mesma forma que REST
</Note>
