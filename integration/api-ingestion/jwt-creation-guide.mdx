---
title: 'Guia de Cria√ß√£o de Tokens JWT para Clientes'
description: 'Guia t√©cnico completo para gera√ß√£o e gerenciamento de tokens JWT para clientes da API de Ingest√£o Nexfar'
icon: 'key'
---

## Vis√£o Geral

Este guia descreve como gerar e gerenciar tokens JWT para clientes da **API de Ingest√£o Nexfar**. Os tokens JWT s√£o a principal forma de autentica√ß√£o para permitir que clientes (distribuidores, farm√°cias, ERPs) enviem dados para a plataforma Nexfar.

<Warning>
  Este guia √© destinado √† equipe t√©cnica Nexfar respons√°vel por onboarding de clientes. Clientes finais **n√£o devem** gerar seus pr√≥prios tokens - eles recebem tokens pr√©-configurados via email.
</Warning>

## Diferen√ßa entre Tokens de Admin e Tokens de Clientes

A API Nexfar utiliza dois tipos distintos de tokens JWT:

| Aspecto | Token de Admin | Token de Cliente (API de Ingest√£o) |
|---------|----------------|-------------------------------------|
| **Finalidade** | Gerenciar usu√°rios, visualizar logs, configurar sistema | Enviar dados de ingest√£o (clientes, produtos, pedidos) |
| **Payload** | `id`, `role`, `sessionId` | `tenant_id`, `environment`, `scopes`, `iat`, `exp` |
| **Gera√ß√£o** | Via API `/auth/email/login` ou banco de dados | Manualmente pela equipe Nexfar (este guia) |
| **Validade** | 24 horas (renov√°vel com refresh token) | Configur√°vel (90-365 dias) |
| **Renova√ß√£o** | Autom√°tica via refresh token | Manual (solicitar √† equipe Nexfar) |
| **Uso** | Endpoints administrativos (`/api/v1/users`, `/api/v1/audit-logs`) | Endpoints de ingest√£o (`/api/v1/clients`, `/graphql`, etc) |

<Note>
  Este documento foca **exclusivamente em Tokens de Cliente** para API de Ingest√£o. Para gerenciamento de usu√°rios administradores, consulte [Gerenciamento de Usu√°rios Administradores](/api-ingestion/admin-users).
</Note>

---

## Estrutura do Token JWT de Cliente

### Payload Obrigat√≥rio

```typescript
export interface JwtPayload {
  tenant_id: string;                  // Identificador √∫nico do cliente Nexfar
  environment: 'sandbox' | 'production'; // Ambiente alvo
  scopes: string[];                   // Permiss√µes ['ingest:write', 'audit:read']
  iat: number;                        // Issued at (Unix timestamp)
  exp: number;                        // Expiration (Unix timestamp)
  sub?: string;                       // Subject (opcional - geralmente = tenant_id)
}
```

### Exemplo de Token Decodificado

```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "tenant_id": "cli_abc123xyz789",
    "environment": "sandbox",
    "scopes": ["ingest:write", "audit:read"],
    "iat": 1699459200,
    "exp": 1707321600,
    "sub": "cli_abc123xyz789"
  },
  "signature": "..."
}
```

<Info>
  A **signature** √© gerada usando o secret configurado em `AUTH_JWT_SECRET` (ambiente) e garante que o token n√£o pode ser adulterado.
</Info>

---

## Pr√©-requisitos para Gerar Tokens

Antes de gerar um token JWT para um cliente, certifique-se de ter:

1. **Client ID √∫nico** - Identificador do cliente no formato `cli_XXXXXXXXX`
2. **Environment definido** - `sandbox` (testes) ou `production` (dados reais)
3. **Scopes apropriados** - Permiss√µes necess√°rias (ex: `["ingest:write", "audit:read"]`)
4. **Validade do token** - Quantos dias o token ser√° v√°lido (ex: 90 dias para Sandbox, 365 dias para Production)
5. **Secret JWT** - Valor de `AUTH_JWT_SECRET` da vari√°vel de ambiente do servidor

<Warning>
  **IMPORTANTE:** O `AUTH_JWT_SECRET` NUNCA deve ser exposto ou compartilhado publicamente. Tokens gerados com secret incorreto ser√£o rejeitados pela API.
</Warning>

---

## M√©todo 1: Gerar Token via Node.js (Recomendado)

### Passo 1: Instalar Depend√™ncias

```bash
npm install jsonwebtoken
```

### Passo 2: Script de Gera√ß√£o

Crie um arquivo `generate-client-jwt.js`:

```javascript
const jwt = require('jsonwebtoken');

// ============================================
// CONFIGURA√á√ÉO - AJUSTAR CONFORME NECESS√ÅRIO
// ============================================

const CLIENT_ID = 'cli_abc123xyz789';  // Identificador √∫nico do cliente
const ENVIRONMENT = 'sandbox';          // 'sandbox' ou 'production'
const SCOPES = ['ingest:write', 'audit:read']; // Permiss√µes
const VALIDITY_DAYS = 90;               // Quantos dias o token ser√° v√°lido

// Secret JWT (DEVE SER O MESMO DO SERVIDOR!)
const JWT_SECRET = process.env.AUTH_JWT_SECRET || 'your-secret-key-change-in-production';

// ============================================
// GERA√á√ÉO DO TOKEN
// ============================================

const now = Math.floor(Date.now() / 1000); // Timestamp Unix atual
const expirationTimestamp = now + (VALIDITY_DAYS * 24 * 60 * 60);

const payload = {
  tenant_id: CLIENT_ID,
  environment: ENVIRONMENT,
  scopes: SCOPES,
  iat: now,
  exp: expirationTimestamp,
  sub: CLIENT_ID  // Subject (opcional)
};

const token = jwt.sign(payload, JWT_SECRET, {
  algorithm: 'HS256'
});

// ============================================
// OUTPUT
// ============================================

console.log('\n=== Token JWT Gerado com Sucesso ===\n');
console.log('Client ID:', CLIENT_ID);
console.log('Environment:', ENVIRONMENT);
console.log('Scopes:', SCOPES.join(', '));
console.log('Issued At:', new Date(now * 1000).toISOString());
console.log('Expires At:', new Date(expirationTimestamp * 1000).toISOString());
console.log('Validity:', VALIDITY_DAYS, 'dias\n');
console.log('--- TOKEN JWT (copie e cole) ---');
console.log(token);
console.log('\n');
```

### Passo 3: Executar o Script

```bash
# Definir secret JWT (DEVE SER O MESMO DO SERVIDOR!)
export AUTH_JWT_SECRET="seu-secret-jwt-do-servidor"

# Executar script
node generate-client-jwt.js
```

**Sa√≠da Esperada:**

```
=== Token JWT Gerado com Sucesso ===

Client ID: cli_abc123xyz789
Environment: sandbox
Scopes: ingest:write, audit:read
Issued At: 2025-11-15T14:30:00.000Z
Expires At: 2026-02-13T14:30:00.000Z
Validity: 90 dias

--- TOKEN JWT (copie e cole) ---
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRfaWQiOiJjbGlfYWJjMTIzIiwiZW52aXJvbm1lbnQiOiJzYW5kYm94Iiwic2NvcGVzIjpbImluZ2VzdGlvbjp3cml0ZSIsImF1ZGl0OnJlYWQiXSwiaWF0IjoxNjk5NDU5MjAwLCJleHAiOjE3MDczMjE2MDAsInN1YiI6ImNsaV9hYmMxMjMifQ.8h3Kx9L2mN4pQ5rS6tU7vW8xY9zA0bC1dE2fG3hI4jK
```

<Check>
  Copie o token completo (string longa) e envie para o cliente via email seguro.
</Check>

---

## M√©todo 2: Gerar Token via Python

### Passo 1: Instalar Depend√™ncias

```bash
pip install pyjwt
```

### Passo 2: Script de Gera√ß√£o

Crie um arquivo `generate_client_jwt.py`:

```python
import jwt
import time
import os
from datetime import datetime, timedelta

# ============================================
# CONFIGURA√á√ÉO - AJUSTAR CONFORME NECESS√ÅRIO
# ============================================

CLIENT_ID = 'cli_abc123xyz789'  # Identificador √∫nico do cliente
ENVIRONMENT = 'sandbox'          # 'sandbox' ou 'production'
SCOPES = ['ingest:write', 'audit:read']  # Permiss√µes
VALIDITY_DAYS = 90               # Quantos dias o token ser√° v√°lido

# Secret JWT (DEVE SER O MESMO DO SERVIDOR!)
JWT_SECRET = os.getenv('AUTH_JWT_SECRET', 'your-secret-key-change-in-production')

# ============================================
# GERA√á√ÉO DO TOKEN
# ============================================

now = int(time.time())  # Timestamp Unix atual
expiration = now + (VALIDITY_DAYS * 24 * 60 * 60)

payload = {
    'tenant_id': CLIENT_ID,
    'environment': ENVIRONMENT,
    'scopes': SCOPES,
    'iat': now,
    'exp': expiration,
    'sub': CLIENT_ID  # Subject (opcional)
}

token = jwt.encode(payload, JWT_SECRET, algorithm='HS256')

# ============================================
# OUTPUT
# ============================================

print('\n=== Token JWT Gerado com Sucesso ===\n')
print(f'Client ID: {CLIENT_ID}')
print(f'Environment: {ENVIRONMENT}')
print(f'Scopes: {", ".join(SCOPES)}')
print(f'Issued At: {datetime.fromtimestamp(now).isoformat()}')
print(f'Expires At: {datetime.fromtimestamp(expiration).isoformat()}')
print(f'Validity: {VALIDITY_DAYS} dias\n')
print('--- TOKEN JWT (copie e cole) ---')
print(token)
print('\n')
```

### Passo 3: Executar o Script

```bash
# Definir secret JWT (DEVE SER O MESMO DO SERVIDOR!)
export AUTH_JWT_SECRET="seu-secret-jwt-do-servidor"

# Executar script
python generate_client_jwt.py
```

---

## M√©todo 3: Gerar Token Online (jwt.io) - Apenas Sandbox

<Warning>
  **NUNCA** use ferramentas online para gerar tokens de **produ√ß√£o**. Use apenas para tokens de **Sandbox** e com secrets de teste.
</Warning>

### Passo 1: Acessar jwt.io

Visite [https://jwt.io](https://jwt.io)

### Passo 2: Configurar Header

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

### Passo 3: Configurar Payload

```json
{
  "tenant_id": "cli_sandbox_test_123",
  "environment": "sandbox",
  "scopes": ["ingest:write", "audit:read"],
  "iat": 1699459200,
  "exp": 1707321600,
  "sub": "cli_sandbox_test_123"
}
```

**Como calcular timestamps:**
- `iat` (Issued At): Timestamp Unix atual ‚Üí [https://www.unixtimestamp.com](https://www.unixtimestamp.com)
- `exp` (Expiration): `iat + (90 * 24 * 60 * 60)` (90 dias)

### Passo 4: Inserir Secret

Na se√ß√£o "Verify Signature", insira o `AUTH_JWT_SECRET` do servidor.

### Passo 5: Copiar Token

Copie o token gerado no campo "Encoded" (lado esquerdo).

<Warning>
  **Lembre-se:** Este m√©todo √© APENAS para Sandbox e testes. Tokens de Production devem ser gerados via scripts (M√©todo 1 ou 2).
</Warning>

---

## Boas Pr√°ticas de Gera√ß√£o de Tokens

### 1. Client ID √önico

Sempre gere um `tenant_id` √∫nico para cada cliente:

```javascript
// Formato recomendado: cli_ + 16 caracteres aleat√≥rios
const crypto = require('crypto');
const clientId = 'cli_' + crypto.randomBytes(8).toString('hex');
// Exemplo: cli_a1b2c3d4e5f6g7h8
```

### 2. Validade por Ambiente

Recomenda√ß√µes de validade do token:

| Environment | Validade Recomendada | Justificativa |
|-------------|---------------------|---------------|
| **Sandbox** | 90 dias | Tempo suficiente para testes, mas for√ßa renova√ß√£o peri√≥dica |
| **Production** | 365 dias | Reduz fric√ß√£o operacional, mas requer renova√ß√£o anual |

<Tip>
  Configure alertas para notificar clientes 30 dias antes da expira√ß√£o do token para evitar interrup√ß√µes no servi√ßo.
</Tip>

### 3. Scopes Apropriados

Defina apenas os scopes necess√°rios:

| Scope | Descri√ß√£o | Quando Usar |
|-------|-----------|-------------|
| `ingest:write` | Permite enviar dados de ingest√£o (POST, PUT) | Sempre para clientes da API |
| `audit:read` | Permite consultar audit log (GET /audit-logs) | Opcional - se cliente precisa rastreabilidade |
| `ingest:read` | Permite consultar dados ingeridos (GET) | Raro - maioria dos clientes s√≥ envia dados |

**Exemplo de Configura√ß√£o:**

```javascript
// Cliente padr√£o (apenas envio)
const scopes = ['ingest:write'];

// Cliente avan√ßado (envio + rastreabilidade)
const scopes = ['ingest:write', 'audit:read'];
```

### 4. Rota√ß√£o de Secrets

<Warning>
  Se o `AUTH_JWT_SECRET` for comprometido, **TODOS** os tokens JWT se tornam inv√°lidos quando o secret √© alterado.
</Warning>

**Processo de Rota√ß√£o de Secret:**

1. Gerar novo secret seguro (min. 32 caracteres)
2. Atualizar vari√°vel de ambiente `AUTH_JWT_SECRET` no servidor
3. Reiniciar aplica√ß√£o NestJS
4. **TODOS** os clientes precisam receber novos tokens JWT

```bash
# Gerar novo secret (Linux/macOS)
openssl rand -base64 32

# Output exemplo: 7Kx9L2mN4pQ5rS6tU7vW8xY9zA0bC1dE2fG3hI4jKs=
```

### 5. Armazenamento Seguro de Tokens Gerados

Mantenha registro de tokens gerados:

```json
{
  "tenant_id": "cli_abc123xyz789",
  "client_name": "Farm√°cia XYZ Distribuidora",
  "environment": "production",
  "scopes": ["ingest:write", "audit:read"],
  "issued_at": "2025-11-15T14:30:00.000Z",
  "expires_at": "2026-11-15T14:30:00.000Z",
  "token_hash": "sha256:a1b2c3d4...",  // N√£o armazene o token completo!
  "status": "active"
}
```

<Tip>
  Armazene apenas um **hash SHA-256** do token, nunca o token completo. Isso previne vazamento acidental.
</Tip>

---

## Fluxo de Onboarding de Cliente

### Processo Completo

```mermaid
sequenceDiagram
    participant Cliente
    participant Nexfar Tech Team
    participant API

    Cliente->>Nexfar Tech Team: Solicita integra√ß√£o
    Nexfar Tech Team->>Nexfar Tech Team: Gera Client ID √∫nico
    Nexfar Tech Team->>Nexfar Tech Team: Gera JWT Sandbox (90 dias)
    Nexfar Tech Team->>Cliente: Email com credenciais Sandbox
    Cliente->>API: Testa integra√ß√£o (Sandbox)
    Cliente->>Nexfar Tech Team: Confirma valida√ß√£o completa
    Nexfar Tech Team->>Nexfar Tech Team: Gera JWT Production (365 dias)
    Nexfar Tech Team->>Cliente: Email com credenciais Production
    Cliente->>API: Envia dados reais (Production)
```

### Template de Email para Onboarding

```
Assunto: Credenciais de Acesso - API de Ingest√£o Nexfar (Sandbox)

Ol√° [Nome do Cliente],

Bem-vindo √† API de Ingest√£o Nexfar! Seguem suas credenciais de acesso ao ambiente Sandbox:

---

**Ambiente:** Sandbox (Testes)
**URL Base:** https://api.nexfar.com.br
**Client ID:** cli_abc123xyz789
**Validade do Token:** 90 dias (at√© 13/02/2026)

**Token JWT:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRfaWQiOiJjbGlfYWJjMTIzIiwiZW52aXJvbm1lbnQiOiJzYW5kYm94Iiwic2NvcGVzIjpbImluZ2VzdGlvbjp3cml0ZSIsImF1ZGl0OnJlYWQiXSwiaWF0IjoxNjk5NDU5MjAwLCJleHAiOjE3MDczMjE2MDAsInN1YiI6ImNsaV9hYmMxMjMifQ.8h3Kx9L2mN4pQ5rS6tU7vW8xY9zA0bC1dE2fG3hI4jK
```

---

**Pr√≥ximos Passos:**

1. Acesse a documenta√ß√£o: https://docs.nexfar.com.br/api-ingestion/quickstart
2. Configure sua aplica√ß√£o para apontar para o Sandbox
3. Envie dados de teste
4. Ap√≥s valida√ß√£o completa, solicite credenciais de Produ√ß√£o

**Importante:**
- ‚ö†Ô∏è Dados no Sandbox s√£o deletados ap√≥s 30 dias
- ‚ö†Ô∏è Use apenas dados fict√≠cios no Sandbox (NUNCA dados reais)
- üîí Armazene o token em vari√°vel de ambiente (n√£o em c√≥digo)

Para d√∫vidas, responda este email ou contate: suporte@nexfar.com.br

Atenciosamente,
Equipe Nexfar
```

---

## Valida√ß√£o e Troubleshooting

### Validar Token Gerado

Ap√≥s gerar o token, valide que est√° correto:

#### Op√ß√£o 1: Decodificar em jwt.io

1. Acesse [https://jwt.io](https://jwt.io)
2. Cole o token no campo "Encoded"
3. Verifique payload no lado direito:
   - ‚úÖ `tenant_id` correto
   - ‚úÖ `environment` correto (`sandbox` ou `production`)
   - ‚úÖ `scopes` corretos
   - ‚úÖ `exp` no futuro (n√£o expirado)

#### Op√ß√£o 2: Testar na API

```bash
# Testar token
curl -X GET https://api.nexfar.com.br/health \
  -H "Authorization: Bearer SEU_TOKEN_AQUI"

# Resposta esperada (200 OK):
{
  "status": "ok",
  "info": {
    "database": { "status": "up" },
    "memory_heap": { "status": "up" }
  }
}
```

<Check>
  Se receber **200 OK**, o token est√° v√°lido e funcional!
</Check>

### Problemas Comuns

<AccordionGroup>

<Accordion title="‚ùå Token Inv√°lido: Signature Invalid">
  **Causa:** Secret JWT usado para gerar o token √© diferente do secret do servidor.

  **Solu√ß√£o:**
  1. Confirme que `AUTH_JWT_SECRET` do script = `AUTH_JWT_SECRET` do servidor
  2. Verifique se n√£o h√° espa√ßos extras ou caracteres ocultos no secret
  3. Regere o token com o secret correto

  **Exemplo de Verifica√ß√£o:**
  ```bash
  # No servidor NestJS
  echo $AUTH_JWT_SECRET

  # No script de gera√ß√£o
  echo $AUTH_JWT_SECRET

  # DEVEM SER ID√äNTICOS
  ```
</Accordion>

<Accordion title="‚ùå Token Expirado: Token has expired">
  **Causa:** Claim `exp` (expiration) est√° no passado.

  **Solu√ß√£o:**
  1. Verifique timestamp de expira√ß√£o em jwt.io
  2. Confirme que `exp` est√° no futuro
  3. Regere o token com nova validade

  **C√°lculo de Expira√ß√£o:**
  ```javascript
  const now = Math.floor(Date.now() / 1000); // Agora
  const exp = now + (90 * 24 * 60 * 60);      // +90 dias

  console.log('Agora:', new Date(now * 1000).toISOString());
  console.log('Expira:', new Date(exp * 1000).toISOString());
  ```
</Accordion>

<Accordion title="‚ùå Client ID N√£o Reconhecido">
  **Causa:** `tenant_id` no token n√£o existe no sistema ou est√° incorreto.

  **Solu√ß√£o:**
  1. Verifique que `tenant_id` segue formato: `cli_XXXXXXXXX`
  2. Confirme que Client ID foi registrado corretamente
  3. Use Client ID consistente em todos os tokens desse cliente

  **Nota:** `tenant_id` √© usado para particionar dados - deve ser √∫nico por cliente.
</Accordion>

<Accordion title="‚ùå Scopes Insuficientes: Forbidden">
  **Causa:** Token n√£o tem scopes necess√°rios para a opera√ß√£o.

  **Exemplo:**
  - Tentou enviar dados (POST) mas token s√≥ tem `audit:read`
  - Tentou consultar audit log mas token s√≥ tem `ingest:write`

  **Solu√ß√£o:**
  1. Verifique scopes atuais do token em jwt.io
  2. Regere token com scopes corretos: `["ingest:write", "audit:read"]`

  **Scopes Recomendados:**
  ```javascript
  // Cliente padr√£o (envio de dados)
  scopes: ['ingest:write']

  // Cliente avan√ßado (envio + rastreabilidade)
  scopes: ['ingest:write', 'audit:read']
  ```
</Accordion>

<Accordion title="‚úÖ Token V√°lido mas Dados N√£o Aparecem">
  **Causa:** Poss√≠vel problema de isolamento de ambiente.

  **Valida√ß√£o:**
  1. Verifique claim `environment` do token em jwt.io
  2. Confirme URL usada:
     - Sandbox: `api-sandbox.nexfar.com.br`
     - Production: `api.nexfar.com.br`
  3. Dados Sandbox NUNCA aparecem em Production (isolamento absoluto)

  **Solu√ß√£o:**
  - Se token Sandbox mas esperava Production: solicite token Production
  - Se token Production mas usando URL Sandbox: corrija URL
</Accordion>

</AccordionGroup>

---

## Seguran√ßa e Compliance

### Prote√ß√£o do Secret JWT

<Warning>
  O `AUTH_JWT_SECRET` √© a chave mestra para todos os tokens JWT. Se comprometido, **TODOS** os tokens devem ser revogados e regenerados.
</Warning>

**Boas Pr√°ticas:**

1. **Nunca exponha em c√≥digo:** Use vari√°veis de ambiente
2. **Rotacione periodicamente:** A cada 6-12 meses
3. **Armazene em secrets manager:** AWS Secrets Manager, Azure Key Vault, HashiCorp Vault
4. **Acesso restrito:** Apenas tech leads e DevOps devem ter acesso
5. **Auditoria:** Mantenha log de quem acessou o secret

### Registro de Tokens Emitidos

Mantenha registro de todos os tokens emitidos:

| Campo | Descri√ß√£o | Exemplo |
|-------|-----------|---------|
| `tenant_id` | Identificador do cliente | `cli_abc123xyz789` |
| `client_name` | Nome da empresa | Farm√°cia XYZ |
| `environment` | Ambiente do token | `sandbox` ou `production` |
| `scopes` | Permiss√µes | `["ingest:write", "audit:read"]` |
| `issued_at` | Data de emiss√£o | `2025-11-15T14:30:00Z` |
| `expires_at` | Data de expira√ß√£o | `2026-02-13T14:30:00Z` |
| `issued_by` | Quem emitiu | `tech@nexfar.com.br` |
| `status` | Status do token | `active`, `expired`, `revoked` |
| `revoked_at` | Data de revoga√ß√£o | `2025-12-01T10:00:00Z` (se revogado) |
| `revoked_reason` | Motivo da revoga√ß√£o | "Client requested new token" |

### Revoga√ß√£o de Tokens

<Warning>
  Tokens JWT s√£o **stateless** - n√£o h√° como revog√°-los individualmente sem implementa√ß√£o adicional.
</Warning>

**Op√ß√µes de Revoga√ß√£o:**

1. **Rota√ß√£o de Secret (Revoga√ß√£o Global):**
   - Altera `AUTH_JWT_SECRET`
   - **TODOS** os tokens existentes se tornam inv√°lidos
   - Exige reemiss√£o de tokens para todos os clientes

2. **Blacklist de Tokens (Implementa√ß√£o Futura):**
   - Manter lista de tokens revogados em Redis
   - API verifica blacklist antes de aceitar token
   - Permite revoga√ß√£o individual de tokens

3. **Expira√ß√£o Curta + Refresh (Implementa√ß√£o Futura):**
   - Tokens de curta dura√ß√£o (ex: 1 hora)
   - Refresh token para renova√ß√£o autom√°tica
   - Cliente revogado: n√£o recebe novo refresh

---

## Automa√ß√£o de Gera√ß√£o de Tokens

### Script CLI Completo

Crie um CLI tool para facilitar gera√ß√£o de tokens:

```javascript
#!/usr/bin/env node
// save as: bin/generate-client-jwt.js

const jwt = require('jsonwebtoken');
const crypto = require('crypto');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

function prompt(question) {
  return new Promise((resolve) => {
    rl.question(question, resolve);
  });
}

async function generateToken() {
  console.log('\n=== Nexfar JWT Token Generator ===\n');

  // Coletar inputs
  const clientName = await prompt('Client Name (Farm√°cia XYZ): ');
  const clientIdInput = await prompt('Client ID (deixe vazio para gerar automaticamente): ');
  const clientId = clientIdInput || 'cli_' + crypto.randomBytes(8).toString('hex');

  const environment = await prompt('Environment (sandbox/production) [sandbox]: ') || 'sandbox';
  const validityDays = parseInt(await prompt('Validade em dias [90]: ') || '90');
  const scopesInput = await prompt('Scopes (separados por v√≠rgula) [ingest:write,audit:read]: ') || 'ingest:write,audit:read';
  const scopes = scopesInput.split(',').map(s => s.trim());

  const secret = process.env.AUTH_JWT_SECRET;
  if (!secret) {
    console.error('\n‚ùå Erro: AUTH_JWT_SECRET n√£o definido!');
    console.error('Execute: export AUTH_JWT_SECRET="your-secret-here"\n');
    rl.close();
    return;
  }

  // Gerar token
  const now = Math.floor(Date.now() / 1000);
  const exp = now + (validityDays * 24 * 60 * 60);

  const payload = {
    tenant_id: clientId,
    environment,
    scopes,
    iat: now,
    exp,
    sub: clientId
  };

  const token = jwt.sign(payload, secret, { algorithm: 'HS256' });

  // Output
  console.log('\n‚úÖ Token JWT Gerado com Sucesso!\n');
  console.log('Client Name:', clientName);
  console.log('Client ID:', clientId);
  console.log('Environment:', environment);
  console.log('Scopes:', scopes.join(', '));
  console.log('Issued At:', new Date(now * 1000).toISOString());
  console.log('Expires At:', new Date(exp * 1000).toISOString());
  console.log('Validity:', validityDays, 'dias\n');
  console.log('--- TOKEN JWT ---');
  console.log(token);
  console.log('\n');

  rl.close();
}

generateToken();
```

**Uso:**

```bash
chmod +x bin/generate-client-jwt.js
export AUTH_JWT_SECRET="your-secret-here"
./bin/generate-client-jwt.js
```

---

## Refer√™ncias

### Documenta√ß√£o Interna

- [Autentica√ß√£o JWT](/api-ingestion/authentication) - Guia para clientes sobre como usar tokens
- [Ambientes: Sandbox vs Produ√ß√£o](/api-ingestion/environments) - Diferen√ßa entre ambientes
- [Gerenciamento de Usu√°rios Administradores](/api-ingestion/admin-users) - Tokens de Admin

### Documenta√ß√£o Externa

- [JWT.io](https://jwt.io) - Ferramenta de decodifica√ß√£o de tokens
- [RFC 7519](https://datatracker.ietf.org/doc/html/rfc7519) - Especifica√ß√£o oficial JWT
- [OWASP JWT Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html)

### Bibliotecas Recomendadas

- **Node.js:** [jsonwebtoken](https://www.npmjs.com/package/jsonwebtoken)
- **Python:** [PyJWT](https://pypi.org/project/PyJWT/)
- **Java:** [java-jwt](https://github.com/auth0/java-jwt)
- **C#:** [System.IdentityModel.Tokens.Jwt](https://www.nuget.org/packages/System.IdentityModel.Tokens.Jwt/)

---

## Suporte

Para d√∫vidas ou problemas relacionados √† gera√ß√£o de tokens JWT:

- **Email:** suporte@nexfar.com.br
- **Slack:** #nexfar-tech-team
- **Documenta√ß√£o T√©cnica:** [docs.nexfar.com.br](https://docs.nexfar.com.br)
