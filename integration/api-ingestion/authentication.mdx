---
title: "Autentica√ß√£o JWT"
description: "Guia completo de autentica√ß√£o JWT para API de Ingest√£o Nexfar: estrutura de tokens, claims, headers HTTP e troubleshooting"
icon: "shield"
---

## Introdu√ß√£o

A API de Ingest√£o Nexfar utiliza **JSON Web Tokens (JWT)** para autenticar todas as requisi√ß√µes. Este token garante que apenas clientes autorizados possam enviar dados e acessar recursos da plataforma.

<Note>
**üìù O que √© JWT?** JSON Web Token √© um padr√£o aberto (RFC 7519) que define uma maneira compacta e segura de transmitir informa√ß√µes entre partes como um objeto JSON. O token √© assinado digitalmente, garantindo sua autenticidade.
</Note>

---

## Como Funciona a Autentica√ß√£o

<Steps>
  <Step title="Receber Token JWT">
    Voc√™ receber√° um email da Nexfar com seu token JWT para ambiente **Sandbox** ou **Production**.

    **O que est√° inclu√≠do:**
    - Token JWT completo (string longa codificada em Base64)
    - Client ID (`client_id`)
    - Environment (`"sandbox"` ou `"production"`)
    - URL da API correspondente
  </Step>

  <Step title="Armazenar Token Seguramente">
    Salve o token em vari√°vel de ambiente (**NUNCA** em c√≥digo):

    ```bash
    # Linux/macOS
    export NEXFAR_JWT="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

    # Windows PowerShell
    $env:NEXFAR_JWT="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    ```

    <Warning>
      **üîí Seguran√ßa:** NUNCA exponha tokens JWT em c√≥digo p√∫blico, logs ou reposit√≥rios Git.
    </Warning>
  </Step>

  <Step title="Incluir Token em Requisi√ß√µes">
    Adicione header `Authorization` em **TODAS** as requisi√ß√µes:

    ```
    Authorization: Bearer {seu_token_jwt_aqui}
    ```

    **Formato obrigat√≥rio:**
    - Palavra `"Bearer"` (B mai√∫sculo)
    - Um espa√ßo
    - Token JWT completo (sem quebras de linha)
  </Step>

  <Step title="API Valida Token">
    A API Nexfar valida automaticamente:
    - ‚úÖ Assinatura do token (garante autenticidade)
    - ‚úÖ Expira√ß√£o (`exp` claim) - token n√£o expirado
    - ‚úÖ Claims obrigat√≥rios (`client_id`, `environment`, `scopes`)

    **Se v√°lido** ‚Üí Requisi√ß√£o processada
    **Se inv√°lido** ‚Üí Erro 401 Unauthorized
  </Step>
</Steps>

---

## Estrutura do Token JWT

Um token JWT √© composto por tr√™s partes separadas por pontos (`.`):

```
header.payload.signature
```

Cada parte √© codificada em **Base64URL**. Exemplo de token real:

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjbGllbnRfaWQiOiJjbGlfYWJjMTIzIiwiZW52aXJvbm1lbnQiOiJzYW5kYm94Iiwic2NvcGVzIjpbImluZ2VzdGlvbjp3cml0ZSIsImF1ZGl0OnJlYWQiXSwiaWF0IjoxNjk5NDU5MjAwLCJleHAiOjE3MDczMjE2MDB9.signature_hash_here
```

### Claims do Payload

O payload do JWT cont√©m informa√ß√µes (claims) sobre o cliente e suas permiss√µes:

| Claim | Tipo | Descri√ß√£o |
|-------|------|-----------|
| `client_id` | string | Identificador √∫nico do cliente (obrigat√≥rio) |
| `environment` | string | Ambiente: `"sandbox"` ou `"production"` |
| `scopes` | array | Permiss√µes (ex: `["ingestion:write", "audit:read"]`) |
| `iat` | number | Issued At - timestamp Unix de emiss√£o |
| `exp` | number | Expiration - timestamp Unix de expira√ß√£o |

<Note>
**üìù Claims Obrigat√≥rios:** Todos os 5 claims acima devem estar presentes no token. A aus√™ncia de qualquer um resultar√° em erro 401.
</Note>

**Exemplo de Payload Decodificado:**

```json
{
  "client_id": "cli_abc123xyz789",
  "environment": "sandbox",
  "scopes": ["ingestion:write", "audit:read"],
  "iat": 1699459200,
  "exp": 1707321600
}
```

---

## Enviando Requisi√ß√µes Autenticadas

### REST API

Use o header `Authorization` com prefixo `Bearer` em todas as requisi√ß√µes REST:

<CodeGroup>

```bash cURL
# REST API - Criar Cliente
curl -X POST https://api-sandbox.nexfar.com.br/api/v1/clients \
  -H "Authorization: Bearer $NEXFAR_JWT" \
  -H "Content-Type: application/json" \
  -d '{
    "cnpj": "12.345.678/0001-90",
    "razao_social": "Farm√°cia Exemplo LTDA",
    "email": "contato@exemplo.com.br",
    "status": "ACTIVE"
  }'
```

```python Python
import requests
import os

# Configura√ß√£o
API_URL = "https://api-sandbox.nexfar.com.br"
JWT_TOKEN = os.getenv("NEXFAR_JWT")  # Token da vari√°vel de ambiente

# Headers de autentica√ß√£o
headers = {
    "Authorization": f"Bearer {JWT_TOKEN}",
    "Content-Type": "application/json"
}

# Dados do cliente
client_data = {
    "cnpj": "12.345.678/0001-90",
    "razao_social": "Farm√°cia Exemplo LTDA",
    "email": "contato@exemplo.com.br",
    "status": "ACTIVE"
}

# REST API
response = requests.post(
    f"{API_URL}/api/v1/clients",
    json=client_data,
    headers=headers
)

print(response.json())
```

```javascript Node.js
const axios = require('axios');

// Configura√ß√£o
const API_URL = 'https://api-sandbox.nexfar.com.br';
const JWT_TOKEN = process.env.NEXFAR_JWT;  // Token da vari√°vel de ambiente

// Headers de autentica√ß√£o
const headers = {
    'Authorization': `Bearer ${JWT_TOKEN}`,
    'Content-Type': 'application/json'
};

// Dados do cliente
const clientData = {
    cnpj: '12.345.678/0001-90',
    razao_social: 'Farm√°cia Exemplo LTDA',
    email: 'contato@exemplo.com.br',
    status: 'ACTIVE'
};

// REST API
const response = await axios.post(
    `${API_URL}/api/v1/clients`,
    clientData,
    { headers }
);

console.log(response.data);
```

```java Java
import java.net.http.*;
import java.net.URI;

// Configura√ß√£o
String apiUrl = "https://api-sandbox.nexfar.com.br";
String jwtToken = System.getenv("NEXFAR_JWT");  // Token da vari√°vel de ambiente

// JSON payload
String jsonData = """
{
  "cnpj": "12.345.678/0001-90",
  "razao_social": "Farm√°cia Exemplo LTDA",
  "email": "contato@exemplo.com.br",
  "status": "ACTIVE"
}
""";

// REST API
HttpRequest request = HttpRequest.newBuilder()
    .uri(URI.create(apiUrl + "/api/v1/clients"))
    .header("Authorization", "Bearer " + jwtToken)
    .header("Content-Type", "application/json")
    .POST(HttpRequest.BodyPublishers.ofString(jsonData))
    .build();

HttpResponse<String> response = HttpClient.newHttpClient()
    .send(request, HttpResponse.BodyHandlers.ofString());

System.out.println(response.body());
```

```csharp C#
using System.Net.Http;
using System.Text;
using System.Text.Json;

// Configura√ß√£o
var apiUrl = "https://api-sandbox.nexfar.com.br";
var jwtToken = Environment.GetEnvironmentVariable("NEXFAR_JWT");

// Cliente HTTP
var client = new HttpClient();
client.DefaultRequestHeaders.Add("Authorization", $"Bearer {jwtToken}");

// Dados do cliente
var clientData = new
{
    cnpj = "12.345.678/0001-90",
    razao_social = "Farm√°cia Exemplo LTDA",
    email = "contato@exemplo.com.br",
    status = "ACTIVE"
};

var jsonData = JsonSerializer.Serialize(clientData);
var content = new StringContent(jsonData, Encoding.UTF8, "application/json");

// REST API
var response = await client.PostAsync($"{apiUrl}/api/v1/clients", content);
var result = await response.Content.ReadAsStringAsync();

Console.WriteLine(result);
```

</CodeGroup>

---

### GraphQL API

A autentica√ß√£o GraphQL usa **exatamente o mesmo header** `Authorization` das requisi√ß√µes REST:

<CodeGroup>

```bash cURL GraphQL
curl -X POST https://api-sandbox.nexfar.com.br/graphql \
  -H "Authorization: Bearer $NEXFAR_JWT" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "mutation { createClient(input: { cnpj: \"12.345.678/0001-90\", razaoSocial: \"Farm√°cia Exemplo LTDA\", email: \"contato@exemplo.com.br\", status: ACTIVE }) { id cnpj razaoSocial } }"
  }'
```

```javascript JavaScript (fetch)
const JWT_TOKEN = process.env.NEXFAR_JWT;

const query = `
  mutation CreateClient($input: CreateClientInput!) {
    createClient(input: $input) {
      id
      cnpj
      razaoSocial
      email
    }
  }
`;

const variables = {
  input: {
    cnpj: "12.345.678/0001-90",
    razaoSocial: "Farm√°cia Exemplo LTDA",
    email: "contato@exemplo.com.br",
    status: "ACTIVE"
  }
};

const response = await fetch('https://api-sandbox.nexfar.com.br/graphql', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${JWT_TOKEN}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ query, variables })
});

const result = await response.json();
console.log(result.data);
```

```python Python (requests)
import requests
import os

JWT_TOKEN = os.getenv("NEXFAR_JWT")

query = """
mutation CreateClient($input: CreateClientInput!) {
  createClient(input: $input) {
    id
    cnpj
    razaoSocial
    email
  }
}
"""

variables = {
    "input": {
        "cnpj": "12.345.678/0001-90",
        "razaoSocial": "Farm√°cia Exemplo LTDA",
        "email": "contato@exemplo.com.br",
        "status": "ACTIVE"
    }
}

headers = {
    "Authorization": f"Bearer {JWT_TOKEN}",
    "Content-Type": "application/json"
}

response = requests.post(
    "https://api-sandbox.nexfar.com.br/graphql",
    json={"query": query, "variables": variables},
    headers=headers
)

print(response.json())
```

</CodeGroup>

<Tip>
**üí° Dica:** A autentica√ß√£o GraphQL e REST √© id√™ntica. Use o mesmo token JWT para ambas as APIs.
</Tip>

---

## Tokens para Sandbox vs Produ√ß√£o

A Nexfar fornece **dois tipos de tokens** com isolamento completo de dados:

| Aspecto | Token Sandbox | Token Production |
|---------|--------------|------------------|
| **Claim `environment`** | `"sandbox"` | `"production"` |
| **URL Base** | `api-sandbox.nexfar.com.br` | `api.nexfar.com.br` |
| **Dados** | Isolados, deletados ap√≥s 30 dias | Persistentes, produ√ß√£o |
| **Solicita√ß√£o** | Email inicial de onboarding | Ap√≥s valida√ß√£o completa em Sandbox |
| **Validade T√≠pica** | 90 dias (renov√°vel) | Configurada individualmente |
| **Finalidade** | Testes, desenvolvimento, integra√ß√£o | Uso em produ√ß√£o, dados reais |

<Warning>
**‚ö†Ô∏è IMPORTANTE:**
- **NUNCA** use token de produ√ß√£o em ambiente de teste
- Dados enviados com token **Sandbox** s√£o automaticamente **deletados ap√≥s 30 dias**
- Use **SEMPRE** Sandbox para desenvolvimento e testes iniciais
</Warning>

<Tip>
**üí° Boas Pr√°ticas:**
- Teste completamente no Sandbox antes de solicitar token Production
- Mantenha tokens Sandbox e Production em vari√°veis de ambiente **separadas**
- Documente qual token usar em cada ambiente (staging, QA, produ√ß√£o)
</Tip>

---

## Expira√ß√£o de Tokens

### Validando Expira√ß√£o

Todo token JWT possui um claim `exp` (expiration) que indica quando o token expira (timestamp Unix):

```python
import time
import jwt

# Decodificar token (sem valida√ß√£o - apenas visualizar)
decoded = jwt.decode(token, options={"verify_signature": False})
exp_timestamp = decoded['exp']
current_timestamp = int(time.time())

if current_timestamp > exp_timestamp:
    print("Token expirado!")
else:
    tempo_restante = exp_timestamp - current_timestamp
    print(f"Token v√°lido por mais {tempo_restante // 3600} horas")
```

<Warning>
**‚ö†Ô∏è Tokens Expirados:** Tokens expirados retornam erro **401 Unauthorized**. Monitore a expira√ß√£o proativamente.
</Warning>

### Como Renovar Token

Quando seu token expirar, siga estes passos:

1. **Detectar erro 401** em sua aplica√ß√£o
2. **Contatar Nexfar** via email: [suporte@nexfar.com.br](mailto:suporte@nexfar.com.br)
3. **Solicitar renova√ß√£o de token** (informar `client_id`)
4. **Novo token ser√° enviado por email**

<Note>
**üìù Validade de Tokens:**
- Tokens de **Sandbox** geralmente t√™m validade de **90 dias**
- Tokens de **Production** t√™m validade configurada individualmente
- **Future enhancement:** API de refresh token (n√£o dispon√≠vel no MVP)
</Note>

---

## Inspecionando Seu Token (JWT.io)

Para visualizar o conte√∫do do seu token JWT sem validar assinatura, use a ferramenta [jwt.io](https://jwt.io):

### Passo a Passo:

1. Acesse [https://jwt.io](https://jwt.io)
2. Cole seu token no campo **"Encoded"** (lado esquerdo)
3. Verifique claims no **payload** (lado direito, se√ß√£o "Payload")
4. Valide os seguintes claims:
   - `client_id`: Seu identificador √∫nico
   - `environment`: `"sandbox"` ou `"production"`
   - `scopes`: Permiss√µes dispon√≠veis
   - `exp`: Timestamp de expira√ß√£o (verifique se est√° no futuro)

<Warning>
**‚ö†Ô∏è Seguran√ßa com JWT.io:**
- **NUNCA** cole tokens de produ√ß√£o em servi√ßos online p√∫blicos
- jwt.io executa JavaScript **localmente no browser** (sem enviar dados para servidor)
- Para tokens sens√≠veis, use bibliotecas locais:
  - **Python:** `pyjwt`
  - **Node.js:** `jsonwebtoken`
  - **Java:** `jjwt`
</Warning>

---

## Troubleshooting - Erros de Autentica√ß√£o

<AccordionGroup>

<Accordion title="‚ùå 401 Unauthorized - Token Inv√°lido ou Expirado">
  **Causas Comuns:**
  - Token malformado (copiado incorretamente)
  - Assinatura inv√°lida (token n√£o emitido pela Nexfar)
  - Token expirado (claim `exp` no passado)
  - Token de ambiente errado (Sandbox token em URL Production)

  **Solu√ß√µes:**
  1. **Verificar c√≥pia do token:** Certifique-se de que copiou o token completo (sem espa√ßos extras ou quebras de linha)
  2. **Validar em jwt.io:** Cole o token em [https://jwt.io](https://jwt.io) e verifique:
     - Claims `client_id`, `environment`, `scopes` est√£o presentes
     - Claim `exp` (expiration) est√° no futuro
  3. **Verificar URL:** Sandbox token deve usar `api-sandbox.nexfar.com.br`, Production token deve usar `api.nexfar.com.br`
  4. **Solicitar novo token:** Se expirado, contate [suporte@nexfar.com.br](mailto:suporte@nexfar.com.br)

  **Exemplo de Erro:**
  ```json
  {
    "statusCode": 401,
    "message": "Unauthorized",
    "error": "Invalid or expired JWT token"
  }
  ```
</Accordion>

<Accordion title="‚ùå 401 Unauthorized - Header de Autentica√ß√£o Ausente">
  **Causa:** Header `Authorization` n√£o foi inclu√≠do na requisi√ß√£o.

  **Solu√ß√£o:** Adicione header `Authorization: Bearer {token}` em **TODAS** as requisi√ß√µes.

  **Exemplo Correto (cURL):**
  ```bash
  curl -H "Authorization: Bearer eyJhbGciOiJIUzI1..." \
       https://api-sandbox.nexfar.com.br/api/v1/clients
  ```

  **Exemplo Incorreto:**
  ```bash
  # ‚ùå Sem header Authorization
  curl https://api-sandbox.nexfar.com.br/api/v1/clients
  ```

  **Exemplo de Erro:**
  ```json
  {
    "statusCode": 401,
    "message": "Unauthorized",
    "error": "Authorization header missing"
  }
  ```
</Accordion>

<Accordion title="‚ùå 403 Forbidden - Permiss√µes Insuficientes">
  **Causa:** Token v√°lido mas sem **scopes** (permiss√µes) necess√°rios para opera√ß√£o.

  **Exemplo:** Tentativa de enviar dados (POST) mas token s√≥ tem scope `audit:read` (sem `ingestion:write`).

  **Solu√ß√µes:**
  1. Verifique scopes do seu token em [jwt.io](https://jwt.io)
  2. Confirme que token tem scope `ingestion:write` para enviar dados
  3. Se scope ausente, contate [suporte@nexfar.com.br](mailto:suporte@nexfar.com.br) e solicite atualiza√ß√£o de permiss√µes

  **Exemplo de Erro:**
  ```json
  {
    "statusCode": 403,
    "message": "Forbidden",
    "error": "Insufficient scopes. Required: ingestion:write"
  }
  ```
</Accordion>

<Accordion title="‚ùå Token Funciona no Postman mas N√£o no C√≥digo">
  **Causas Comuns:**
  - Espa√ßo extra no header: `"Bearer  {token}"` (dois espa√ßos ao inv√©s de um)
  - Token armazenado em vari√°vel errada ou n√£o carregado
  - Encoding UTF-8 incorreto
  - Token com quebras de linha (`\n`)

  **Solu√ß√µes:**
  1. **Logar header completo no c√≥digo:**
     ```python
     print(f"Authorization: {headers['Authorization']}")
     ```
  2. **Comparar com formato correto:** `"Bearer {token}"` (um espa√ßo apenas, sem quebras)
  3. **Testar com token hardcoded temporariamente** (apenas para debug, remover depois)
  4. **Verificar se vari√°vel de ambiente foi carregada:**
     ```python
     import os
     token = os.getenv("NEXFAR_JWT")
     if not token:
         print("Erro: NEXFAR_JWT n√£o configurado!")
     ```
</Accordion>

<Accordion title="‚úÖ Token V√°lido mas Dados N√£o Aparecem">
  **Valida√ß√£o:** Confirme que token tem claim `environment` correto para o ambiente esperado.

  **Cen√°rio Comum:**
  - Token **Sandbox** ‚Üí dados em ambiente **Sandbox** (isolado de Production)
  - Token **Production** ‚Üí dados em ambiente **Production**
  - Se enviou com token Sandbox mas esperava ver em Production: s√£o ambientes **separados**!

  **Solu√ß√£o:**
  1. Verifique claim `environment` em [jwt.io](https://jwt.io)
  2. Se token Sandbox mas precisa Production: solicite token Production via [suporte@nexfar.com.br](mailto:suporte@nexfar.com.br)
  3. Consulte dados no ambiente correto: [Ambientes](/integration/api-ingestion/environments)
</Accordion>

</AccordionGroup>

---

## Boas Pr√°ticas de Seguran√ßa

<Warning>
**üîí Tokens JWT t√™m o mesmo poder que uma senha - proteja-os adequadamente**
</Warning>

### 1. Armazenar tokens em vari√°veis de ambiente

‚úÖ **Correto:** Usar vari√°veis de ambiente
```python
# Python
import os
JWT_TOKEN = os.getenv("NEXFAR_JWT")
```

```javascript
// Node.js
const JWT_TOKEN = process.env.NEXFAR_JWT;
```

‚ùå **Incorreto:** Hardcode tokens no c√≥digo
```python
# ‚ùå NUNCA fa√ßa isso!
JWT_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

---

### 2. Nunca commitar tokens em Git

- Adicione `.env` ao `.gitignore`
- Use secrets managers (AWS Secrets Manager, Azure Key Vault, GitHub Secrets)
- Revise commits antes de push para garantir que n√£o h√° tokens expostos

---

### 3. Renovar tokens antes da expira√ß√£o

- Implemente l√≥gica de verifica√ß√£o de `exp`
- Alertar equipe **7 dias antes** de expirar
- Automatize monitoramento de expira√ß√£o

---

### 4. N√£o compartilhar tokens entre ambientes

- **Sandbox token** ‚Üí apenas testes e desenvolvimento
- **Production token** ‚Üí apenas aplica√ß√£o em produ√ß√£o
- Mantenha tokens em vari√°veis de ambiente **separadas**

---

### 5. Limitar acesso aos tokens

- Apenas desenvolvedores **autorizados** t√™m acesso
- Rotacionar tokens se houver suspeita de vazamento
- N√£o compartilhar tokens via email, Slack, ou outros canais inseguros

---

## Pr√≥ximos Passos

<CardGroup cols={2}>

<Card title="Testar no Sandbox" icon="flask" href="/integration/api-ingestion/quickstart">
  Use token Sandbox para enviar primeira requisi√ß√£o seguindo o Quick Start Guide.
</Card>

<Card title="Entender Ambientes" icon="layer-group" href="/integration/api-ingestion/environments">
  Aprenda a diferen√ßa entre Sandbox e Production e quando usar cada um.
</Card>

<Card title="Explorar API Reference" icon="book" href="/integration/api-reference">
  Teste endpoints REST e GraphQL com JWT configurado.
</Card>

<Card title="Code Examples Avan√ßados" icon="code" href="/integration/api-ingestion/code-examples">
  Exemplos completos de integra√ß√£o em 5 linguagens de programa√ß√£o.
</Card>

</CardGroup>

---

<Tip>
**üí° Dicas Finais:**
- Salve seu JWT token em **vari√°vel de ambiente** para seguran√ßa
- Use [jwt.io](https://jwt.io) para inspecionar claims e verificar expira√ß√£o
- **Sempre** teste autentica√ß√£o no Sandbox antes de Production
- Mantenha tokens seguros e nunca exponha em c√≥digo p√∫blico
</Tip>

<Note>
**üìù Token Stateless:** Tokens JWT s√£o stateless - a API valida assinatura **sem consultar banco de dados**. Isso garante performance e escalabilidade.
</Note>
