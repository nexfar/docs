---
title: 'Gerenciamento de Usuários Administradores'
description: 'Guia completo para cadastro e gerenciamento de usuários administradores da API de Ingestão'
icon: 'user-shield'
---

## Visão Geral

Este guia descreve como criar, gerenciar e administrar usuários com permissões administrativas na API de Ingestão Nexfar. Usuários administradores têm privilégios especiais para gerenciar outros usuários, visualizar logs de auditoria e configurar a plataforma.

<Warning>
  As operações descritas neste guia requerem privilégios de administrador. Certifique-se de que apenas pessoal autorizado tenha acesso às credenciais de admin.
</Warning>

## Pré-requisitos

Antes de começar, você precisará de:

- Acesso ao banco de dados PostgreSQL da aplicação
- Credenciais de administrador existentes (para criar via API)
- Ferramentas: `psql`, `curl`, ou cliente REST (Postman, Insomnia)

## Tipos de Usuários

A API suporta dois tipos principais de usuários:

| Role | ID | Descrição | Permissões |
|------|----|-----------| ---------- |
| **Admin** | `1` | Administrador do sistema | Acesso total: gerenciar usuários, visualizar logs, configurar sistema |
| **User** | `2` | Usuário padrão | Acesso limitado: apenas recursos próprios |

## Método 1: Criar Admin via Banco de Dados (Bootstrap Inicial)

Este método é usado para criar o **primeiro usuário administrador** do sistema, quando ainda não há nenhum admin disponível.

### Passo 1: Conectar ao Banco de Dados

```bash
# Ambiente local (Docker)
psql -h localhost -p 5432 -U root -d api

# Ambiente production (NeonDB/PostgreSQL remoto)
psql -h <host> -p 5432 -U <username> -d <database>
```

### Passo 2: Inserir Roles e Statuses (se necessário)

```sql
-- Inserir roles (Admin e User)
INSERT INTO "role" ("id", "name")
VALUES
  (1, 'Admin'),
  (2, 'User')
ON CONFLICT (id) DO NOTHING;

-- Inserir statuses (Active e Inactive)
INSERT INTO "status" ("id", "name")
VALUES
  (1, 'Active'),
  (2, 'Inactive')
ON CONFLICT (id) DO NOTHING;
```

### Passo 3: Criar Hash da Senha

Você precisa gerar um hash bcrypt da senha. Use Node.js ou um serviço online:

```javascript
// Script Node.js para gerar hash
const bcrypt = require('bcryptjs');
const password = 'senha-super-segura-admin';
const salt = bcrypt.genSaltSync(10);
const hash = bcrypt.hashSync(password, salt);
console.log(hash);
// Output: $2a$10$abcdefghijklmnopqrstuvwxyz...
```

### Passo 4: Inserir Usuário Admin

```sql
-- Inserir usuário administrador
INSERT INTO "user" (
  "email",
  "password",
  "firstName",
  "lastName",
  "provider",
  "roleId",
  "statusId",
  "createdAt",
  "updatedAt"
)
VALUES (
  'admin@nexfar.com.br',
  '$2a$10$seu-hash-bcrypt-aqui',  -- Hash gerado no passo anterior
  'Admin',
  'Sistema',
  'email',
  1,  -- Role: Admin
  1,  -- Status: Active
  NOW(),
  NOW()
)
ON CONFLICT ("email") DO NOTHING;
```

### Passo 5: Verificar Criação

```sql
-- Verificar usuário criado
SELECT
  id,
  email,
  "firstName",
  "lastName",
  "roleId",
  "statusId"
FROM "user"
WHERE email = 'admin@nexfar.com.br';
```

<Check>
  Se a query retornar o usuário com `roleId = 1` e `statusId = 1`, o admin foi criado com sucesso!
</Check>

---

## Método 2: Criar Admin via API (Recomendado)

Este método usa a API REST para criar novos usuários administradores. **Requer autenticação com um usuário admin existente**.

### Passo 1: Fazer Login como Admin

```bash
curl -X POST https://api.nexfar.com.br/api/v1/auth/email/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@nexfar.com.br",
    "password": "senha-super-segura-admin"
  }'
```

**Resposta:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "tokenExpires": 1699999999999,
  "user": {
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "email": "admin@nexfar.com.br",
    "role": { "id": 1, "name": "Admin" },
    "status": { "id": 1, "name": "Active" }
  }
}
```

<Info>
  Salve o **token** retornado. Você precisará dele para criar novos usuários.
</Info>

### Passo 2: Criar Novo Usuário Admin

```bash
curl -X POST https://api.nexfar.com.br/api/v1/users \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer SEU_TOKEN_AQUI" \
  -d '{
    "email": "novo.admin@nexfar.com.br",
    "password": "senha-segura-123",
    "firstName": "João",
    "lastName": "Silva",
    "role": {
      "id": 1
    },
    "status": {
      "id": 1
    }
  }'
```

**Resposta de Sucesso (201 Created):**
```json
{
  "id": "456e4567-e89b-12d3-a456-426614174001",
  "email": "novo.admin@nexfar.com.br",
  "firstName": "João",
  "lastName": "Silva",
  "provider": "email",
  "role": {
    "id": 1,
    "name": "Admin"
  },
  "status": {
    "id": 1,
    "name": "Active"
  },
  "createdAt": "2024-01-15T10:30:00.000Z",
  "updatedAt": "2024-01-15T10:30:00.000Z"
}
```

### Passo 3: Testar Login do Novo Admin

```bash
curl -X POST https://api.nexfar.com.br/api/v1/auth/email/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "novo.admin@nexfar.com.br",
    "password": "senha-segura-123"
  }'
```

<Check>
  Se o login retornar um token, o novo administrador foi criado com sucesso!
</Check>

---

## Operações Administrativas

### Listar Todos os Usuários

```bash
curl -X GET https://api.nexfar.com.br/api/v1/users?page=1&limit=10 \
  -H "Authorization: Bearer SEU_TOKEN_ADMIN"
```

**Resposta:**
```json
{
  "data": [
    {
      "id": "123e4567-e89b-12d3-a456-426614174000",
      "email": "admin@nexfar.com.br",
      "firstName": "Admin",
      "lastName": "Sistema",
      "role": { "id": 1, "name": "Admin" },
      "status": { "id": 1, "name": "Active" }
    },
    {
      "id": "456e4567-e89b-12d3-a456-426614174001",
      "email": "usuario@cliente.com",
      "firstName": "Maria",
      "lastName": "Santos",
      "role": { "id": 2, "name": "User" },
      "status": { "id": 1, "name": "Active" }
    }
  ],
  "hasNextPage": false
}
```

### Atualizar Usuário Existente

```bash
curl -X PATCH https://api.nexfar.com.br/api/v1/users/{user-id} \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer SEU_TOKEN_ADMIN" \
  -d '{
    "firstName": "João Atualizado",
    "status": {
      "id": 2
    }
  }'
```

### Promover Usuário a Admin

```bash
curl -X PATCH https://api.nexfar.com.br/api/v1/users/{user-id} \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer SEU_TOKEN_ADMIN" \
  -d '{
    "role": {
      "id": 1
    }
  }'
```

### Desativar Usuário

```bash
curl -X PATCH https://api.nexfar.com.br/api/v1/users/{user-id} \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer SEU_TOKEN_ADMIN" \
  -d '{
    "status": {
      "id": 2
    }
  }'
```

### Deletar Usuário (Soft Delete)

```bash
curl -X DELETE https://api.nexfar.com.br/api/v1/users/{user-id} \
  -H "Authorization: Bearer SEU_TOKEN_ADMIN"
```

---

## Boas Práticas de Segurança

<Warning>
  **IMPORTANTE:** Siga estas recomendações para manter a segurança do sistema:
</Warning>

### 1. Senhas Fortes

- Mínimo de 8 caracteres
- Combinação de letras maiúsculas, minúsculas, números e símbolos
- Nunca use senhas óbvias como "admin123" ou "password"

### 2. Rotação de Credenciais

```bash
# Atualizar senha do próprio admin (via PATCH /auth/me)
curl -X PATCH https://api.nexfar.com.br/api/v1/auth/me \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer SEU_TOKEN" \
  -d '{
    "password": "nova-senha-super-segura",
    "oldPassword": "senha-antiga"
  }'
```

### 3. Auditoria de Acesso

Monitore regularmente os logs de auditoria para detectar acessos suspeitos:

```bash
curl -X GET https://api.nexfar.com.br/api/v1/audit-logs?userId={admin-id} \
  -H "Authorization: Bearer SEU_TOKEN_ADMIN"
```

### 4. Princípio do Menor Privilégio

- Crie admins apenas quando absolutamente necessário
- Use usuários regulares (`roleId: 2`) para operações normais
- Revogue privilégios de admin quando não forem mais necessários

### 5. Variáveis de Ambiente

Configure secrets seguros no `.env`:

```bash
# NUNCA use estes valores em produção!
AUTH_JWT_SECRET=gere-uma-string-aleatoria-longa-e-complexa
AUTH_REFRESH_SECRET=outra-string-diferente-e-igualmente-complexa
AUTH_FORGOT_SECRET=mais-uma-string-unica-para-forgot-password
AUTH_CONFIRM_EMAIL_SECRET=string-para-confirmacao-de-email
```

---

## Troubleshooting

### Erro: "Unauthorized" ao criar usuário

**Problema:** Token inválido ou expirado

**Solução:**
```bash
# 1. Faça login novamente para obter novo token
curl -X POST https://api.nexfar.com.br/api/v1/auth/email/login \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@nexfar.com.br", "password": "sua-senha"}'

# 2. Use o novo token nas requisições
```

### Erro: "Email already exists"

**Problema:** Email já cadastrado no sistema

**Solução:**
```bash
# Listar usuários para verificar duplicatas
curl -X GET "https://api.nexfar.com.br/api/v1/users?filters[email]=$eq:novo.admin@nexfar.com.br" \
  -H "Authorization: Bearer SEU_TOKEN_ADMIN"
```

### Erro: "Forbidden" ao acessar endpoints de admin

**Problema:** Usuário não tem permissão de admin (`roleId != 1`)

**Solução:**
```bash
# Verificar role do usuário atual
curl -X GET https://api.nexfar.com.br/api/v1/auth/me \
  -H "Authorization: Bearer SEU_TOKEN"

# Se necessário, peça a outro admin para promover seu usuário
```

### Esqueci a senha do único admin

**Problema:** Não há como recuperar via API

**Solução:** Reset via banco de dados:
```sql
-- 1. Gerar novo hash de senha (use script Node.js do Método 1)
-- 2. Atualizar no banco de dados
UPDATE "user"
SET password = '$2a$10$novo-hash-aqui'
WHERE email = 'admin@nexfar.com.br';
```

---

## Referências

- [Autenticação JWT](/api-ingestion/authentication)
- [Ambientes (Sandbox vs Produção)](/api-ingestion/environments)
- [Logs de Auditoria](/api-ingestion/audit-log)
- [OpenAPI Specification](https://docs.nexfar.com.br/api-reference/users/create)

---

## Suporte

Para dúvidas ou problemas relacionados ao gerenciamento de usuários administradores:

- **Email:** suporte@nexfar.com.br
- **Slack:** #nexfar-integration-support
- **Documentação Técnica:** [docs.nexfar.com.br](https://docs.nexfar.com.br)
